<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.3">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #6d6d6d; -webkit-text-stroke: #6d6d6d}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #6b0001; -webkit-text-stroke: #6b0001}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #0000ff; -webkit-text-stroke: #0000ff}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #4d5055; -webkit-text-stroke: #4d5055}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; -webkit-text-stroke: #000000}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #fb0007; -webkit-text-stroke: #fb0007}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; -webkit-text-stroke: #000000; min-height: 16.0px}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #18702b; -webkit-text-stroke: #18702b}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #137646; -webkit-text-stroke: #137646}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #0e6e6d; -webkit-text-stroke: #0e6e6d}
    span.s1 {font-kerning: none; background-color: #ecf1f7}
    span.s2 {font-kerning: none; color: #fb0007; background-color: #ecf1f7; -webkit-text-stroke: 0px #fb0007}
    span.s3 {font-kerning: none; color: #2a2a2a; background-color: #ecf1f7; -webkit-text-stroke: 0px #2a2a2a}
    span.s4 {font-kerning: none; color: #6b0001; background-color: #ecf1f7; -webkit-text-stroke: 0px #6b0001}
    span.s5 {font-kerning: none; color: #000000; background-color: #ecf1f7; -webkit-text-stroke: 0px #000000}
    span.s6 {font-kerning: none; color: #137646; background-color: #ecf1f7; -webkit-text-stroke: 0px #137646}
    span.s7 {font-kerning: none; color: #093c94; background-color: #ecf1f7; -webkit-text-stroke: 0px #093c94}
    span.s8 {font-kerning: none}
    span.s9 {font-kerning: none; color: #4d5055; background-color: #ecf1f7; -webkit-text-stroke: 0px #4d5055}
    span.s10 {font-kerning: none; color: #6f0ec3; background-color: #ecf1f7; -webkit-text-stroke: 0px #6f0ec3}
    span.s11 {font-kerning: none; color: #18702b; background-color: #ecf1f7; -webkit-text-stroke: 0px #18702b}
    span.s12 {font-kerning: none; color: #0000ff; background-color: #ecf1f7; -webkit-text-stroke: 0px #0000ff}
    span.s13 {font-kerning: none; color: #a4450b; background-color: #ecf1f7; -webkit-text-stroke: 0px #a4450b}
    span.s14 {font-kerning: none; color: #0e6e6d; background-color: #ecf1f7; -webkit-text-stroke: 0px #0e6e6d}
  </style>
</head>
<body>
<p class="p1"><span class="s1">&lt;!DOCTYPE</span><span class="s2"> html</span><span class="s1">&gt;</span></p>
<p class="p2"><span class="s3">&lt;</span><span class="s1">html</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;</span><span class="s1">head</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s3">&lt;</span><span class="s4">meta</span><span class="s5"> </span><span class="s2">name</span><span class="s3">=</span><span class="s1">"viewport"</span><span class="s5"> </span><span class="s2">content</span><span class="s3">=</span><span class="s1">"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;</span><span class="s1">style</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">/* --- 基本スタイル --- */</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">html</span><span class="s5">, </span><span class="s1">body</span><span class="s5"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s2">width:</span><span class="s1"> </span><span class="s6">100%</span><span class="s1">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">height:</span><span class="s5"> </span><span class="s6">100%</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">margin:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">padding:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">background-color:</span><span class="s5"> </span><span class="s7">#222</span><span class="s5">;</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s2">overflow:</span><span class="s5"> </span><span class="s7">hidden</span><span class="s5">; </span><span class="s1">/* スクロール完全禁止 */</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s4">body</span><span class="s1"> {<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s2">color:</span><span class="s1"> </span><span class="s7">white</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s2">font-family:</span><span class="s5"> </span><span class="s1">'Courier New'</span><span class="s5">, </span><span class="s7">sans-serif</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">display:</span><span class="s5"> </span><span class="s7">flex</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">flex-direction:</span><span class="s5"> </span><span class="s7">column</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">justify-content:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">align-items:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s2">position:</span><span class="s5"> </span><span class="s7">fixed</span><span class="s5">; </span><span class="s1">/* 画面固定 */</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">top:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; </span><span class="s1">left:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; </span><span class="s1">right:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; </span><span class="s1">bottom:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">overscroll-behavior:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">;</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s2">touch-action:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">; </span><span class="s1">/* ピンチズーム等禁止 */</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">user-select:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">-webkit-user-select:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">-webkit-touch-callout:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">   </span></span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">/* Canvas設定 */</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">canvas</span><span class="s5"> {<span class="Apple-converted-space"> </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">background-color:</span><span class="s5"> </span><span class="s7">#87CEEB</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s2">border:</span><span class="s1"> </span><span class="s6">2px</span><span class="s1"> </span><span class="s7">solid</span><span class="s1"> </span><span class="s7">#fff</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s2">box-shadow:</span><span class="s1"> </span><span class="s6">0</span><span class="s1"> </span><span class="s6">0</span><span class="s1"> </span><span class="s6">20px</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s6">0</span><span class="s1">,</span><span class="s6">0</span><span class="s1">,</span><span class="s6">0</span><span class="s1">,</span><span class="s6">0.5</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">/* デフォルトPC用 */</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s2">width:</span><span class="s1"> </span><span class="s6">800px</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s2">height:</span><span class="s1"> </span><span class="s6">400px</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">   </span></span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">/* ★修正: スマホ縦持ち時のCanvas最適化 */</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">/* 画面幅に合わせて縮小表示し、横幅を稼ぐ */</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span>@</span><span class="s1">media</span><span class="s5"> (</span><span class="s1">max-width:</span><span class="s5"> 800</span><span class="s1">px</span><span class="s5">) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>canvas {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s2">width:</span><span class="s1"> </span><span class="s6">100vw</span><span class="s1">;<span class="Apple-converted-space">        </span></span><span class="s9">/* スマホの横幅いっぱいに */</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s2">height:</span><span class="s1"> </span><span class="s7">auto</span><span class="s1">;<span class="Apple-converted-space">        </span></span><span class="s9">/* アスペクト比維持 */</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">          </span></span><span class="s2">max-height:</span><span class="s5"> </span><span class="s6">60vh</span><span class="s5">;<span class="Apple-converted-space">    </span></span><span class="s1">/* 縦長になりすぎないように制限 */</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s2">object-fit:</span><span class="s1"> </span><span class="s7">contain</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">/* --- UIレイヤー --- */</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">#ui-layer</span><span class="s5"> {<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s2">position:</span><span class="s1"> </span><span class="s7">absolute</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s2">top:</span><span class="s1"> </span><span class="s6">10px</span><span class="s1">; </span><span class="s2">left:</span><span class="s1"> </span><span class="s6">10px</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">font-size:</span><span class="s5"> </span><span class="s6">20px</span><span class="s5">; </span><span class="s1">font-weight:</span><span class="s5"> </span><span class="s7">bold</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s2">color:</span><span class="s1"> </span><span class="s7">black</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">pointer-events:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s2">text-shadow:</span><span class="s1"> </span><span class="s6">1px</span><span class="s1"> </span><span class="s6">1px</span><span class="s1"> </span><span class="s6">0</span><span class="s1"> </span><span class="s7">#fff</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s2">z-index:</span><span class="s1"> </span><span class="s6">5</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p9"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s2">background:</span><span class="s5"> </span><span class="s7">rgba(</span><span class="s1">255</span><span class="s5">,</span><span class="s1">255</span><span class="s5">,</span><span class="s1">255</span><span class="s5">,</span><span class="s1">0.3</span><span class="s7">)</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s2">padding:</span><span class="s1"> </span><span class="s6">5px</span><span class="s1">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">border-radius:</span><span class="s5"> </span><span class="s6">5px</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">#hearts</span><span class="s5"> { </span><span class="s1">color:</span><span class="s5"> </span><span class="s7">red</span><span class="s5">; </span><span class="s1">font-size:</span><span class="s5"> </span><span class="s6">24px</span><span class="s5">; }</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">#status-msg</span><span class="s5"> { </span><span class="s1">font-size:</span><span class="s5"> </span><span class="s6">16px</span><span class="s5">; </span><span class="s1">margin-top:</span><span class="s5"> </span><span class="s6">5px</span><span class="s5">; }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">/* --- タイトル画面 --- */</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">#title-screen</span><span class="s5"> {</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">position:</span><span class="s5"> </span><span class="s7">absolute</span><span class="s5">; </span><span class="s1">top:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; </span><span class="s1">left:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; </span><span class="s1">width:</span><span class="s5"> </span><span class="s6">100%</span><span class="s5">; </span><span class="s1">height:</span><span class="s5"> </span><span class="s6">100%</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">display:</span><span class="s5"> </span><span class="s7">flex</span><span class="s5">; </span><span class="s1">flex-direction:</span><span class="s5"> </span><span class="s7">column</span><span class="s5">; </span><span class="s1">justify-content:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">; </span><span class="s1">align-items:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">background:</span><span class="s5"> </span><span class="s7">rgba(</span><span class="s6">0</span><span class="s5">,</span><span class="s6">0</span><span class="s5">,</span><span class="s6">0</span><span class="s5">,</span><span class="s6">0.4</span><span class="s7">)</span><span class="s5">; </span><span class="s1">z-index:</span><span class="s5"> </span><span class="s6">10</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">pointer-events:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">   </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">.title-img</span><span class="s5"> { </span><span class="s1">max-width:</span><span class="s5"> </span><span class="s6">40%</span><span class="s5">; </span><span class="s1">height:</span><span class="s5"> </span><span class="s7">auto</span><span class="s5">; </span><span class="s1">margin-bottom:</span><span class="s5"> </span><span class="s6">20px</span><span class="s5">; </span><span class="s1">opacity:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; }</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">   </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">.start-text</span><span class="s5"> { </span><span class="s1">font-size:</span><span class="s5"> </span><span class="s6">30px</span><span class="s5">; </span><span class="s1">color:</span><span class="s5"> </span><span class="s7">white</span><span class="s5">; </span><span class="s1">text-shadow:</span><span class="s5"> </span><span class="s6">2px</span><span class="s5"> </span><span class="s6">2px</span><span class="s5"> </span><span class="s7">#000</span><span class="s5">; </span><span class="s1">font-weight:</span><span class="s5"> </span><span class="s7">bold</span><span class="s5">; </span><span class="s1">opacity:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; }</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">   </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">@keyframes</span><span class="s5"> </span><span class="s7">slideUpFade</span><span class="s5"> { </span><span class="s6">0%</span><span class="s5"> { </span><span class="s1">opacity:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; </span><span class="s1">transform:</span><span class="s5"> </span><span class="s7">translateY(</span><span class="s6">100px</span><span class="s7">)</span><span class="s5">; } </span><span class="s6">100%</span><span class="s5"> { </span><span class="s1">opacity:</span><span class="s5"> </span><span class="s6">1</span><span class="s5">; </span><span class="s1">transform:</span><span class="s5"> </span><span class="s7">translateY(</span><span class="s6">0</span><span class="s7">)</span><span class="s5">; } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">@keyframes</span><span class="s1"> </span><span class="s7">blinkFade</span><span class="s1"> { </span><span class="s6">0%</span><span class="s1"> { </span><span class="s2">opacity:</span><span class="s1"> </span><span class="s6">0</span><span class="s1">; } </span><span class="s6">100%</span><span class="s1"> { </span><span class="s2">opacity:</span><span class="s1"> </span><span class="s6">1</span><span class="s1">; } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">@keyframes</span><span class="s1"> </span><span class="s7">blinkRed</span><span class="s1"> { </span><span class="s6">0%</span><span class="s1"> { </span><span class="s2">color:</span><span class="s1"> </span><span class="s7">red</span><span class="s1">; } </span><span class="s6">50%</span><span class="s1"> { </span><span class="s2">color:</span><span class="s1"> </span><span class="s7">white</span><span class="s1">; } </span><span class="s6">100%</span><span class="s1"> { </span><span class="s2">color:</span><span class="s1"> </span><span class="s7">red</span><span class="s1">; } }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">/* --- ゲームオーバー・ランキング画面 --- */</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">#overlay</span><span class="s5"> {<span class="Apple-converted-space"> </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">position:</span><span class="s5"> </span><span class="s7">absolute</span><span class="s5">; </span><span class="s1">top:</span><span class="s5"> </span><span class="s6">50%</span><span class="s5">; </span><span class="s1">left:</span><span class="s5"> </span><span class="s6">50%</span><span class="s5">; </span><span class="s1">transform:</span><span class="s5"> </span><span class="s7">translate(</span><span class="s6">-50%</span><span class="s5">, </span><span class="s6">-50%</span><span class="s7">)</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">background:</span><span class="s5"> </span><span class="s7">rgba(</span><span class="s6">0</span><span class="s5">, </span><span class="s6">0</span><span class="s5">, </span><span class="s6">0</span><span class="s5">, </span><span class="s6">0.9</span><span class="s7">)</span><span class="s5">; </span><span class="s1">border:</span><span class="s5"> </span><span class="s6">2px</span><span class="s5"> </span><span class="s7">solid</span><span class="s5"> </span><span class="s7">white</span><span class="s5">; </span><span class="s1">border-radius:</span><span class="s5"> </span><span class="s6">10px</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">padding:</span><span class="s5"> </span><span class="s6">20px</span><span class="s5">; </span><span class="s1">text-align:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">; </span><span class="s1">color:</span><span class="s5"> </span><span class="s7">white</span><span class="s5">; </span><span class="s1">display:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">; </span><span class="s1">width:</span><span class="s5"> </span><span class="s6">90%</span><span class="s5">; </span><span class="s1">max-width:</span><span class="s5"> </span><span class="s6">400px</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">z-index:</span><span class="s5"> </span><span class="s6">200</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">h2</span><span class="s5"> { </span><span class="s1">margin-top:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; </span><span class="s1">color:</span><span class="s5"> </span><span class="s7">yellow</span><span class="s5">; </span><span class="s1">text-shadow:</span><span class="s5"> </span><span class="s6">2px</span><span class="s5"> </span><span class="s6">2px</span><span class="s5"> </span><span class="s7">#f00</span><span class="s5">; </span><span class="s1">font-size:</span><span class="s5"> </span><span class="s6">24px</span><span class="s5">; }</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">   </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">table</span><span class="s5"> { </span><span class="s1">width:</span><span class="s5"> </span><span class="s6">100%</span><span class="s5">; </span><span class="s1">border-collapse:</span><span class="s5"> </span><span class="s7">collapse</span><span class="s5">; </span><span class="s1">margin:</span><span class="s5"> </span><span class="s6">10px</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; </span><span class="s1">font-size:</span><span class="s5"> </span><span class="s6">14px</span><span class="s5">; }</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">th</span><span class="s5">, </span><span class="s4">td</span><span class="s5"> { </span><span class="s1">border-bottom:</span><span class="s5"> </span><span class="s6">1px</span><span class="s5"> </span><span class="s7">solid</span><span class="s5"> </span><span class="s7">#555</span><span class="s5">; </span><span class="s1">padding:</span><span class="s5"> </span><span class="s6">4px</span><span class="s5">; </span><span class="s1">text-align:</span><span class="s5"> </span><span class="s7">left</span><span class="s5">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s4">th</span><span class="s1"> { </span><span class="s2">color:</span><span class="s1"> </span><span class="s7">#aaa</span><span class="s1">; }</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">.rank-col</span><span class="s5"> { </span><span class="s1">width:</span><span class="s5"> </span><span class="s6">30px</span><span class="s5">; </span><span class="s1">text-align:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">; }</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">.score-col</span><span class="s5"> { </span><span class="s1">text-align:</span><span class="s5"> </span><span class="s7">right</span><span class="s5">; </span><span class="s1">color:</span><span class="s5"> </span><span class="s7">#0f0</span><span class="s5">; }</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">   </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">#input-section</span><span class="s5"> { </span><span class="s1">margin-bottom:</span><span class="s5"> </span><span class="s6">15px</span><span class="s5">; </span><span class="s1">display:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">; }</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">input</span><span class="s5">[</span><span class="s7">type</span><span class="s5">=</span><span class="s11">"text"</span><span class="s5">] { </span><span class="s1">padding:</span><span class="s5"> </span><span class="s6">5px</span><span class="s5">; </span><span class="s1">font-size:</span><span class="s5"> </span><span class="s6">16px</span><span class="s5">; </span><span class="s1">width:</span><span class="s5"> </span><span class="s6">60%</span><span class="s5">; </span><span class="s1">text-align:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">; </span><span class="s1">user-select:</span><span class="s5"> </span><span class="s7">text</span><span class="s5">; </span><span class="s1">-webkit-user-select:</span><span class="s5"> </span><span class="s7">text</span><span class="s5">; }</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">button</span><span class="s5"> { </span><span class="s1">padding:</span><span class="s5"> </span><span class="s6">5px</span><span class="s5"> </span><span class="s6">15px</span><span class="s5">; </span><span class="s1">font-size:</span><span class="s5"> </span><span class="s6">16px</span><span class="s5">; </span><span class="s1">cursor:</span><span class="s5"> </span><span class="s7">pointer</span><span class="s5">; </span><span class="s1">background:</span><span class="s5"> </span><span class="s7">#f00</span><span class="s5">; </span><span class="s1">color:</span><span class="s5"> </span><span class="s7">white</span><span class="s5">; </span><span class="s1">border:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">; </span><span class="s1">font-weight:</span><span class="s5"> </span><span class="s7">bold</span><span class="s5">; </span><span class="s1">margin-left:</span><span class="s5"> </span><span class="s6">5px</span><span class="s5">; }</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">   </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">#loading-msg</span><span class="s5"> { </span><span class="s1">display:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">; </span><span class="s1">color:</span><span class="s5"> </span><span class="s7">yellow</span><span class="s5">; </span><span class="s1">font-weight:</span><span class="s5"> </span><span class="s7">bold</span><span class="s5">; </span><span class="s1">margin-top:</span><span class="s5"> </span><span class="s6">10px</span><span class="s5">; </span><span class="s1">animation:</span><span class="s5"> </span><span class="s7">blink</span><span class="s5"> </span><span class="s6">1s</span><span class="s5"> </span><span class="s7">infinite</span><span class="s5">; }</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">.restart-msg</span><span class="s5"> { </span><span class="s1">margin-top:</span><span class="s5"> </span><span class="s6">15px</span><span class="s5">; </span><span class="s1">font-size:</span><span class="s5"> </span><span class="s6">14px</span><span class="s5">; </span><span class="s1">color:</span><span class="s5"> </span><span class="s7">#ccc</span><span class="s5">; }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">#auto-restart-msg</span><span class="s5"> {</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">display:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">; </span><span class="s1">color:</span><span class="s5"> </span><span class="s7">#00d2ff</span><span class="s5">; </span><span class="s1">margin-top:</span><span class="s5"> </span><span class="s6">15px</span><span class="s5">; </span><span class="s1">font-size:</span><span class="s5"> </span><span class="s6">16px</span><span class="s5">; </span><span class="s1">font-weight:</span><span class="s5"> </span><span class="s7">bold</span><span class="s5">; </span><span class="s1">animation:</span><span class="s5"> </span><span class="s7">blink</span><span class="s5"> </span><span class="s6">1s</span><span class="s5"> </span><span class="s7">infinite</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">/* --- 縦画面警告 (PCでは非表示、スマホで横のとき表示) --- */</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">#orientation-warning</span><span class="s5"> {</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">display:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">; </span><span class="s1">position:</span><span class="s5"> </span><span class="s7">fixed</span><span class="s5">; </span><span class="s1">top:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; </span><span class="s1">left:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; </span><span class="s1">width:</span><span class="s5"> </span><span class="s6">100%</span><span class="s5">; </span><span class="s1">height:</span><span class="s5"> </span><span class="s6">100%</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">background:</span><span class="s5"> </span><span class="s7">rgba(</span><span class="s6">0</span><span class="s5">,</span><span class="s6">0</span><span class="s5">,</span><span class="s6">0</span><span class="s5">,</span><span class="s6">0.95</span><span class="s7">)</span><span class="s5">; </span><span class="s1">z-index:</span><span class="s5"> </span><span class="s6">9999</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">flex-direction:</span><span class="s5"> </span><span class="s7">column</span><span class="s5">; </span><span class="s1">justify-content:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">; </span><span class="s1">align-items:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">text-align:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">; </span><span class="s1">color:</span><span class="s5"> </span><span class="s7">white</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">.rotate-icon</span><span class="s5"> { </span><span class="s1">font-size:</span><span class="s5"> </span><span class="s6">60px</span><span class="s5">; </span><span class="s1">margin-bottom:</span><span class="s5"> </span><span class="s6">20px</span><span class="s5">; }</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s4">.rotate-msg</span><span class="s5"> { </span><span class="s1">font-size:</span><span class="s5"> </span><span class="s6">24px</span><span class="s5">; </span><span class="s1">font-weight:</span><span class="s5"> </span><span class="s7">bold</span><span class="s5">; </span><span class="s1">animation:</span><span class="s5"> </span><span class="s7">blinkRed</span><span class="s5"> </span><span class="s6">1s</span><span class="s5"> </span><span class="s7">infinite</span><span class="s5">; </span><span class="s1">padding:</span><span class="s5"> </span><span class="s6">20px</span><span class="s5">; }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">/* --- モバイルコントローラー --- */</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">#mobile-controls</span><span class="s5"> {</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">display:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">position:</span><span class="s5"> </span><span class="s7">absolute</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">bottom:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; </span><span class="s1">left:</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; </span><span class="s1">width:</span><span class="s5"> </span><span class="s6">100%</span><span class="s5">; </span><span class="s1">height:</span><span class="s5"> </span><span class="s6">180px</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">z-index:</span><span class="s5"> </span><span class="s6">100</span><span class="s5">; </span><span class="s1">pointer-events:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">justify-content:</span><span class="s5"> </span><span class="s7">space-between</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s2">padding:</span><span class="s1"> </span><span class="s6">10px</span><span class="s1"> </span><span class="s6">20px</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">box-sizing:</span><span class="s5"> </span><span class="s7">border-box</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">align-items:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">; </span><span class="s9">/* 上下中央 */</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">/* スマホ・タブレット用表示設定 */</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span>@</span><span class="s1">media</span><span class="s5"> (</span><span class="s1">hover:</span><span class="s5"> </span><span class="s1">none</span><span class="s5">) </span><span class="s1">and</span><span class="s5"> (</span><span class="s1">pointer:</span><span class="s5"> </span><span class="s1">coarse</span><span class="s5">) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>#mobile-controls { </span><span class="s2">display:</span><span class="s1"> </span><span class="s7">flex</span><span class="s1">; }</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">.restart-msg</span><span class="s5"> { </span><span class="s2">display:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">.joystick-area</span><span class="s5"> {</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">pointer-events:</span><span class="s5"> </span><span class="s7">auto</span><span class="s5">; </span><span class="s1">width:</span><span class="s5"> </span><span class="s6">120px</span><span class="s5">; </span><span class="s1">height:</span><span class="s5"> </span><span class="s6">120px</span><span class="s5">;<span class="Apple-converted-space"> </span></span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">background:</span><span class="s5"> </span><span class="s7">rgba(</span><span class="s6">255</span><span class="s5">, </span><span class="s6">255</span><span class="s5">, </span><span class="s6">255</span><span class="s5">, </span><span class="s6">0.1</span><span class="s7">)</span><span class="s5">; </span><span class="s1">border:</span><span class="s5"> </span><span class="s6">2px</span><span class="s5"> </span><span class="s7">solid</span><span class="s5"> </span><span class="s7">rgba(</span><span class="s6">255</span><span class="s5">, </span><span class="s6">255</span><span class="s5">, </span><span class="s6">255</span><span class="s5">, </span><span class="s6">0.3</span><span class="s7">)</span><span class="s5">; </span><span class="s1">border-radius:</span><span class="s5"> </span><span class="s6">50%</span><span class="s5">; </span><span class="s1">touch-action:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">position:</span><span class="s5"> </span><span class="s7">relative</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">.joystick-knob</span><span class="s5"> {</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">width:</span><span class="s5"> </span><span class="s6">50px</span><span class="s5">; </span><span class="s1">height:</span><span class="s5"> </span><span class="s6">50px</span><span class="s5">; </span><span class="s1">background:</span><span class="s5"> </span><span class="s7">rgba(</span><span class="s6">0</span><span class="s5">, </span><span class="s6">210</span><span class="s5">, </span><span class="s6">255</span><span class="s5">, </span><span class="s6">0.8</span><span class="s7">)</span><span class="s5">; </span><span class="s1">border-radius:</span><span class="s5"> </span><span class="s6">50%</span><span class="s5">; </span><span class="s1">position:</span><span class="s5"> </span><span class="s7">absolute</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">top:</span><span class="s5"> </span><span class="s6">50%</span><span class="s5">; </span><span class="s1">left:</span><span class="s5"> </span><span class="s6">50%</span><span class="s5">; </span><span class="s1">transform:</span><span class="s5"> </span><span class="s7">translate(</span><span class="s6">-50%</span><span class="s5">, </span><span class="s6">-50%</span><span class="s7">)</span><span class="s5">; </span><span class="s1">box-shadow:</span><span class="s5"> </span><span class="s6">0</span><span class="s5"> </span><span class="s6">0</span><span class="s5"> </span><span class="s6">10px</span><span class="s5"> </span><span class="s7">rgba(</span><span class="s6">0</span><span class="s5">, </span><span class="s6">210</span><span class="s5">, </span><span class="s6">255</span><span class="s5">, </span><span class="s6">0.5</span><span class="s7">)</span><span class="s5">; </span><span class="s1">pointer-events:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">.action-btn-area</span><span class="s5"> { </span><span class="s2">pointer-events:</span><span class="s5"> </span><span class="s7">auto</span><span class="s5">; }</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">.touch-btn</span><span class="s5"> {</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">width:</span><span class="s5"> </span><span class="s6">90px</span><span class="s5">; </span><span class="s1">height:</span><span class="s5"> </span><span class="s6">90px</span><span class="s5">; </span><span class="s1">border-radius:</span><span class="s5"> </span><span class="s6">50%</span><span class="s5">; </span><span class="s1">background:</span><span class="s5"> </span><span class="s7">rgba(</span><span class="s6">255</span><span class="s5">, </span><span class="s6">255</span><span class="s5">, </span><span class="s6">255</span><span class="s5">, </span><span class="s6">0.2</span><span class="s7">)</span><span class="s5">; </span><span class="s1">border:</span><span class="s5"> </span><span class="s6">2px</span><span class="s5"> </span><span class="s7">solid</span><span class="s5"> </span><span class="s7">rgba(</span><span class="s6">255</span><span class="s5">, </span><span class="s6">255</span><span class="s5">, </span><span class="s6">255</span><span class="s5">, </span><span class="s6">0.6</span><span class="s7">)</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">color:</span><span class="s5"> </span><span class="s7">white</span><span class="s5">; </span><span class="s1">font-size:</span><span class="s5"> </span><span class="s6">40px</span><span class="s5">; </span><span class="s1">display:</span><span class="s5"> </span><span class="s7">flex</span><span class="s5">; </span><span class="s1">justify-content:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">; </span><span class="s1">align-items:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">; </span><span class="s1">touch-action:</span><span class="s5"> </span><span class="s7">manipulation</span><span class="s5">;</span></p>
<p class="p6"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">user-select:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">; </span><span class="s1">-webkit-user-select:</span><span class="s5"> </span><span class="s7">none</span><span class="s5">; </span><span class="s1">cursor:</span><span class="s5"> </span><span class="s7">pointer</span><span class="s5">; </span><span class="s1">text-shadow:</span><span class="s5"> </span><span class="s6">1px</span><span class="s5"> </span><span class="s6">1px</span><span class="s5"> </span><span class="s6">2px</span><span class="s5"> </span><span class="s7">black</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">.touch-btn:active</span><span class="s5"> { </span><span class="s2">background:</span><span class="s5"> </span><span class="s7">rgba(</span><span class="s6">255</span><span class="s5">, </span><span class="s6">255</span><span class="s5">, </span><span class="s6">255</span><span class="s5">, </span><span class="s6">0.5</span><span class="s7">)</span><span class="s5">; }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p2"><span class="s3">&lt;/</span><span class="s1">style</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;/</span><span class="s1">head</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;</span><span class="s1">body</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p4"><span class="s1">&lt;!-- 横画面警告（縦にしてね） --&gt;</span></p>
<p class="p3"><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"orientation-warning"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"rotate-icon"</span><span class="s3">&gt;</span><span class="s5">📱⟲</span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s1"> </span><span class="s2">class</span><span class="s3">=</span><span class="s12">"rotate-msg"</span><span class="s3">&gt;</span><span class="s1">Please Rotate to Portrait</span><span class="s3">&lt;</span><span class="s4">br</span><span class="s3">&gt;</span><span class="s1">画面を縦にしてください</span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">style</span><span class="s3">=</span><span class="s1">"margin-top:20px; color:#aaa;"</span><span class="s3">&gt;</span><span class="s5">Game Paused</span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;/</span><span class="s1">div</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p3"><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"ui-layer"</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>Score: </span><span class="s3">&lt;</span><span class="s4">span</span><span class="s1"> </span><span class="s2">id</span><span class="s3">=</span><span class="s12">"score"</span><span class="s3">&gt;</span><span class="s1">0</span><span class="s3">&lt;/</span><span class="s4">span</span><span class="s3">&gt;</span><span class="s1"> | Level: </span><span class="s3">&lt;</span><span class="s4">span</span><span class="s1"> </span><span class="s2">id</span><span class="s3">=</span><span class="s12">"level"</span><span class="s3">&gt;</span><span class="s1">1</span><span class="s3">&lt;/</span><span class="s4">span</span><span class="s3">&gt;&lt;</span><span class="s4">br</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>Life: </span><span class="s3">&lt;</span><span class="s4">span</span><span class="s1"> </span><span class="s2">id</span><span class="s3">=</span><span class="s12">"hearts"</span><span class="s3">&gt;</span><span class="s1">❤️❤️❤️</span><span class="s3">&lt;/</span><span class="s4">span</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"status-msg"</span><span class="s3">&gt;&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;/</span><span class="s1">div</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p4"><span class="s1">&lt;!-- ゲームキャンバス --&gt;</span></p>
<p class="p3"><span class="s3">&lt;</span><span class="s4">canvas</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"gameCanvas"</span><span class="s5"> </span><span class="s2">width</span><span class="s3">=</span><span class="s1">"800"</span><span class="s5"> </span><span class="s2">height</span><span class="s3">=</span><span class="s1">"400"</span><span class="s3">&gt;&lt;/</span><span class="s4">canvas</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p3"><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"title-screen"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">img</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"title-img"</span><span class="s5"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"title-img"</span><span class="s5"> </span><span class="s2">src</span><span class="s3">=</span><span class="s1">"https://raw.githubusercontent.com/m-fukuda-blip/game/main/game_title.png"</span><span class="s5"> </span><span class="s2">alt</span><span class="s3">=</span><span class="s1">"GAME TITLE"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"start-text"</span><span class="s5"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"start-text"</span><span class="s3">&gt;</span><span class="s5">GAME START!</span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;/</span><span class="s1">div</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p3"><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"overlay"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">h2</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"overlay-title"</span><span class="s3">&gt;</span><span class="s5">GAME OVER</span><span class="s3">&lt;/</span><span class="s4">h2</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"final-score-display"</span><span class="s5"> </span><span class="s2">style</span><span class="s3">=</span><span class="s1">"font-size: 24px; margin-bottom: 15px;"</span><span class="s3">&gt;&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"input-section"</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s4">p</span><span class="s1"> </span><span class="s2">style</span><span class="s3">=</span><span class="s12">"color: cyan;"</span><span class="s3">&gt;</span><span class="s1">🎉 NEW RECORD! 🎉</span><span class="s3">&lt;/</span><span class="s4">p</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s4">input</span><span class="s5"> </span><span class="s2">type</span><span class="s3">=</span><span class="s1">"text"</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"player-name"</span><span class="s5"> </span><span class="s2">placeholder</span><span class="s3">=</span><span class="s1">"Enter Name"</span><span class="s5"> </span><span class="s2">maxlength</span><span class="s3">=</span><span class="s1">"8"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s4">button</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"submit-btn"</span><span class="s5"> </span><span class="s2">onclick</span><span class="s3">=</span><span class="s1">"submitScore()"</span><span class="s3">&gt;</span><span class="s5">Save</span><span class="s3">&lt;/</span><span class="s4">button</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s1"> </span><span class="s2">id</span><span class="s3">=</span><span class="s12">"loading-msg"</span><span class="s3">&gt;</span><span class="s1">⏳ Saving...</span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"ranking-section"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"rank-loading"</span><span class="s5"> </span><span class="s2">style</span><span class="s3">=</span><span class="s1">"color:#aaa; display:none;"</span><span class="s3">&gt;</span><span class="s5">Loading Ranking...</span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s1">table</span><span class="s3">&gt;&lt;</span><span class="s1">thead</span><span class="s3">&gt;&lt;</span><span class="s1">tr</span><span class="s3">&gt;&lt;</span><span class="s1">th</span><span class="s5"> </span><span class="s2">class</span><span class="s3">=</span><span class="s12">"rank-col"</span><span class="s3">&gt;</span><span class="s5">#</span><span class="s3">&lt;/</span><span class="s1">th</span><span class="s3">&gt;&lt;</span><span class="s1">th</span><span class="s3">&gt;</span><span class="s5">Name</span><span class="s3">&lt;/</span><span class="s1">th</span><span class="s3">&gt;&lt;</span><span class="s1">th</span><span class="s5"> </span><span class="s2">class</span><span class="s3">=</span><span class="s12">"score-col"</span><span class="s3">&gt;</span><span class="s5">Score</span><span class="s3">&lt;/</span><span class="s1">th</span><span class="s3">&gt;&lt;/</span><span class="s1">tr</span><span class="s3">&gt;&lt;/</span><span class="s1">thead</span><span class="s3">&gt;&lt;</span><span class="s1">tbody</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s12">"ranking-body"</span><span class="s3">&gt;&lt;/</span><span class="s1">tbody</span><span class="s3">&gt;&lt;/</span><span class="s1">table</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s1"> </span><span class="s2">class</span><span class="s3">=</span><span class="s12">"restart-msg"</span><span class="s3">&gt;</span><span class="s1">Press 'R' to Restart</span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"auto-restart-msg"</span><span class="s3">&gt;&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;/</span><span class="s1">div</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p3"><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"mobile-controls"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"joystick-area"</span><span class="s5"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"joystick-area"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"joystick-knob"</span><span class="s5"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"joystick-knob"</span><span class="s3">&gt;&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"action-btn-area"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s2">id</span><span class="s3">=</span><span class="s1">"btn-jump"</span><span class="s5"> </span><span class="s2">class</span><span class="s3">=</span><span class="s1">"touch-btn"</span><span class="s5"> </span><span class="s2">style</span><span class="s3">=</span><span class="s1">"background: rgba(255, 200, 0, 0.4);"</span><span class="s3">&gt;</span><span class="s5">▲</span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;/</span><span class="s1">div</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p2"><span class="s3">&lt;</span><span class="s1">script</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>document.addEventListener(</span><span class="s11">'contextmenu'</span><span class="s1">, event =&gt; event.preventDefault());</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">// Prevent pull-to-refresh on mobile</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>document.body.addEventListener(</span><span class="s11">'touchmove'</span><span class="s1">, </span><span class="s10">function</span><span class="s1">(e) { </span><span class="s10">if</span><span class="s1">(e.cancelable) e.preventDefault(); }, { passive: </span><span class="s10">false</span><span class="s1"> });</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> canvas = document.getElementById(</span><span class="s11">'gameCanvas'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> ctx = canvas.getContext(</span><span class="s11">'2d'</span><span class="s1">);</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">   </span></span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">// スマホ判定</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> isMobile = (</span><span class="s11">'ontouchstart'</span><span class="s1"> </span><span class="s10">in</span><span class="s1"> window) || (navigator.maxTouchPoints &gt; </span><span class="s13">0</span><span class="s1">) || (window.innerWidth &lt; </span><span class="s13">800</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">let</span><span class="s1"> isPaused = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> orientationWarning = document.getElementById(</span><span class="s11">'orientation-warning'</span><span class="s1">);</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">// ★修正: 画面向きチェック &amp; Canvasサイズ設定 (縦画面最適化)</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> checkOrientationAndResize() {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">if</span><span class="s1"> (isMobile) {</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">          </span></span><span class="s1">// 横長の場合 -&gt; 警告を出してポーズ</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s10">if</span><span class="s1"> (window.innerWidth &gt; window.innerHeight) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">              </span>isPaused = </span><span class="s10">true</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">              </span>orientationWarning.style.display = </span><span class="s11">'flex'</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span>} </span><span class="s10">else</span><span class="s1"> {</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">              </span></span><span class="s1">// 縦長の場合 -&gt; ゲーム再開</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">              </span>isPaused = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">              </span>orientationWarning.style.display = </span><span class="s11">'none'</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">               </span></span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">              </span></span><span class="s1">// ★重要: Canvas解像度は大きく(640px)確保し、CSSで縮小表示する。</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">              </span>canvas.width = </span><span class="s13">640</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">              </span>canvas.height = </span><span class="s13">400</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>} </span><span class="s10">else</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s9">// PC</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span>canvas.width = </span><span class="s13">800</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span>canvas.height = </span><span class="s13">400</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">   </span></span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">// 読み込み時とリサイズ時にチェック</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>window.addEventListener(</span><span class="s11">'resize'</span><span class="s1">, checkOrientationAndResize);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>checkOrientationAndResize();</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> scoreEl = document.getElementById(</span><span class="s11">'score'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> levelEl = document.getElementById(</span><span class="s11">'level'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> heartsEl = document.getElementById(</span><span class="s11">'hearts'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> statusMsgEl = document.getElementById(</span><span class="s11">'status-msg'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> overlay = document.getElementById(</span><span class="s11">'overlay'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> inputSection = document.getElementById(</span><span class="s11">'input-section'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> rankingBody = document.getElementById(</span><span class="s11">'ranking-body'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> finalScoreDisplay = document.getElementById(</span><span class="s11">'final-score-display'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> nameInput = document.getElementById(</span><span class="s11">'player-name'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> submitBtn = document.getElementById(</span><span class="s11">'submit-btn'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> loadingMsg = document.getElementById(</span><span class="s11">'loading-msg'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> rankLoading = document.getElementById(</span><span class="s11">'rank-loading'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> autoRestartMsg = document.getElementById(</span><span class="s11">'auto-restart-msg'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> titleScreen = document.getElementById(</span><span class="s11">'title-screen'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> titleImg = document.getElementById(</span><span class="s11">'title-img'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> startText = document.getElementById(</span><span class="s11">'start-text'</span><span class="s1">);</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">// ジョイスティック</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> joystickArea = document.getElementById(</span><span class="s11">'joystick-area'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> joystickKnob = document.getElementById(</span><span class="s11">'joystick-knob'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">let</span><span class="s1"> stickTouchId = </span><span class="s10">null</span><span class="s1">;</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">if</span><span class="s1"> (joystickArea) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">const</span><span class="s1"> maxRadius = </span><span class="s13">40</span><span class="s1">; </span><span class="s10">const</span><span class="s1"> center = { x: </span><span class="s13">60</span><span class="s1">, y: </span><span class="s13">60</span><span class="s1"> };<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>joystickArea.addEventListener(</span><span class="s11">'touchstart'</span><span class="s1">, (e) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span>e.preventDefault(); </span><span class="s10">const</span><span class="s1"> touch = e.changedTouches[</span><span class="s13">0</span><span class="s1">]; stickTouchId = touch.identifier; startBGM(); updateStick(touch);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>}, {passive: </span><span class="s10">false</span><span class="s1">});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>joystickArea.addEventListener(</span><span class="s11">'touchmove'</span><span class="s1">, (e) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span>e.preventDefault();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> i = </span><span class="s13">0</span><span class="s1">; i &lt; e.changedTouches.length; i++) { </span><span class="s10">if</span><span class="s1"> (e.changedTouches[i].identifier === stickTouchId) { updateStick(e.changedTouches[i]); </span><span class="s10">break</span><span class="s1">; } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>}, {passive: </span><span class="s10">false</span><span class="s1">});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">const</span><span class="s1"> endStick = (e) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span>e.preventDefault();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> i = </span><span class="s13">0</span><span class="s1">; i &lt; e.changedTouches.length; i++) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">              </span></span><span class="s10">if</span><span class="s1"> (e.changedTouches[i].identifier === stickTouchId) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                  </span>stickTouchId = </span><span class="s10">null</span><span class="s1">; joystickKnob.style.transform = </span><span class="s11">`translate(-50%, -50%) translate(0px, 0px)`</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                  </span>keys.left = </span><span class="s10">false</span><span class="s1">; keys.right = </span><span class="s10">false</span><span class="s1">; keys.down = </span><span class="s10">false</span><span class="s1">; </span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">              </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>joystickArea.addEventListener(</span><span class="s11">'touchend'</span><span class="s1">, endStick); joystickArea.addEventListener(</span><span class="s11">'touchcancel'</span><span class="s1">, endStick);</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">function</span><span class="s1"> updateStick(touch) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s10">const</span><span class="s1"> rect = joystickArea.getBoundingClientRect();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s10">let</span><span class="s1"> x = touch.clientX - rect.left - center.x; </span><span class="s10">let</span><span class="s1"> y = touch.clientY - rect.top - center.y;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s10">const</span><span class="s1"> distance = </span><span class="s14">Math</span><span class="s1">.sqrt(x*x + y*y);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s10">if</span><span class="s1"> (distance &gt; maxRadius) { </span><span class="s10">const</span><span class="s1"> angle = </span><span class="s14">Math</span><span class="s1">.atan2(y, x); x = </span><span class="s14">Math</span><span class="s1">.cos(angle) * maxRadius; y = </span><span class="s14">Math</span><span class="s1">.sin(angle) * maxRadius; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span>joystickKnob.style.transform = </span><span class="s11">`translate(-50%, -50%) translate(</span><span class="s1">${x}</span><span class="s11">px, </span><span class="s1">${y}</span><span class="s11">px)`</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span>keys.left = </span><span class="s10">false</span><span class="s1">; keys.right = </span><span class="s10">false</span><span class="s1">; keys.down = </span><span class="s10">false</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s10">if</span><span class="s1"> (distance &gt; </span><span class="s13">10</span><span class="s1">) { </span><span class="s10">if</span><span class="s1"> (</span><span class="s14">Math</span><span class="s1">.abs(x) &gt; </span><span class="s14">Math</span><span class="s1">.abs(y)) { </span><span class="s10">if</span><span class="s1"> (x &gt; </span><span class="s13">0</span><span class="s1">) keys.right = </span><span class="s10">true</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> keys.left = </span><span class="s10">true</span><span class="s1">; } </span><span class="s10">else</span><span class="s1"> { </span><span class="s10">if</span><span class="s1"> (y &gt; </span><span class="s13">0</span><span class="s1">) keys.down = </span><span class="s10">true</span><span class="s1">; } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">   </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> btnJump = document.getElementById(</span><span class="s11">'btn-jump'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">if</span><span class="s1">(btnJump) { btnJump.addEventListener(</span><span class="s11">'touchstart'</span><span class="s1">, (e) =&gt; { e.preventDefault(); doJump(); }); }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">// ... (ゲームロジック変数) ...</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">let</span><span class="s1"> screenShake = { x: </span><span class="s13">0</span><span class="s1">, y: </span><span class="s13">0</span><span class="s1">, duration: </span><span class="s13">0</span><span class="s1">, intensity: </span><span class="s13">0</span><span class="s1"> };</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> addShake(intensity, duration) { screenShake.intensity = intensity; screenShake.duration = duration; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> updateShake() { </span><span class="s10">if</span><span class="s1"> (screenShake.duration &gt; </span><span class="s13">0</span><span class="s1">) { screenShake.x = (</span><span class="s14">Math</span><span class="s1">.random() - </span><span class="s13">0.5</span><span class="s1">) * screenShake.intensity; screenShake.y = (</span><span class="s14">Math</span><span class="s1">.random() - </span><span class="s13">0.5</span><span class="s1">) * screenShake.intensity; screenShake.duration--; } </span><span class="s10">else</span><span class="s1"> { screenShake.x = </span><span class="s13">0</span><span class="s1">; screenShake.y = </span><span class="s13">0</span><span class="s1">; } }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">let</span><span class="s1"> particles = [];</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> spawnParticles(x, y, color, count = </span><span class="s13">8</span><span class="s1">) { </span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> i = </span><span class="s13">0</span><span class="s1">; i &lt; count; i++) { particles.push({ x: x, y: y, vx: (</span><span class="s14">Math</span><span class="s1">.random() - </span><span class="s13">0.5</span><span class="s1">) * </span><span class="s13">8</span><span class="s1">, vy: (</span><span class="s14">Math</span><span class="s1">.random() - </span><span class="s13">0.5</span><span class="s1">) * </span><span class="s13">8</span><span class="s1">, life: </span><span class="s13">30</span><span class="s1"> + </span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">20</span><span class="s1">, size: </span><span class="s13">4</span><span class="s1"> + </span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">4</span><span class="s1">, color: color }); } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> updateAndDrawParticles() { </span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> i = </span><span class="s13">0</span><span class="s1">; i &lt; particles.length; i++) { </span><span class="s10">let</span><span class="s1"> p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += </span><span class="s13">0.2</span><span class="s1">; p.life--; p.size *= </span><span class="s13">0.95</span><span class="s1">; </span><span class="s10">if</span><span class="s1"> (p.life &lt;= </span><span class="s13">0</span><span class="s1"> || p.size &lt; </span><span class="s13">0.5</span><span class="s1">) { particles.splice(i, </span><span class="s13">1</span><span class="s1">); i--; } } }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">let</span><span class="s1"> audioCtx, isBgmPlaying = </span><span class="s10">false</span><span class="s1">, bgmTimeout = </span><span class="s10">null</span><span class="s1">, activeOscillators = [];</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s5"> </span><span class="s1">BASE_BPM</span><span class="s5"> = </span><span class="s13">130</span><span class="s5">, </span><span class="s1">BASE_BEAT_TIME</span><span class="s5"> = </span><span class="s13">60</span><span class="s5"> / </span><span class="s1">BASE_BPM</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> melody = [</span><span class="s13">5</span><span class="s1">,</span><span class="s13">5</span><span class="s1">,</span><span class="s13">6</span><span class="s1">,</span><span class="s13">5</span><span class="s1">,</span><span class="s13">3</span><span class="s1">,-</span><span class="s13">1</span><span class="s1">,</span><span class="s13">3</span><span class="s1">,</span><span class="s13">5</span><span class="s1">, </span><span class="s13">5</span><span class="s1">,</span><span class="s13">5</span><span class="s1">,</span><span class="s13">6</span><span class="s1">,</span><span class="s13">5</span><span class="s1">,</span><span class="s13">3</span><span class="s1">,-</span><span class="s13">1</span><span class="s1">,</span><span class="s13">3</span><span class="s1">,</span><span class="s13">2</span><span class="s1">, </span><span class="s13">5</span><span class="s1">,</span><span class="s13">5</span><span class="s1">,</span><span class="s13">6</span><span class="s1">,</span><span class="s13">5</span><span class="s1">,</span><span class="s13">8</span><span class="s1">,</span><span class="s13">8</span><span class="s1">,</span><span class="s13">7</span><span class="s1">,</span><span class="s13">6</span><span class="s1">, </span><span class="s13">6</span><span class="s1">,</span><span class="s13">5</span><span class="s1">,</span><span class="s13">3</span><span class="s1">,</span><span class="s13">3</span><span class="s1">,-</span><span class="s13">1</span><span class="s1">,</span><span class="s13">5</span><span class="s1">,-</span><span class="s13">1</span><span class="s1">,-</span><span class="s13">1</span><span class="s1">];</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> scaleToFreq = (num) =&gt; { </span><span class="s10">if</span><span class="s1">(num &lt; </span><span class="s13">0</span><span class="s1">) </span><span class="s10">return</span><span class="s1"> </span><span class="s10">null</span><span class="s1">; </span><span class="s10">const</span><span class="s1"> scale = [</span><span class="s13">261.63</span><span class="s1">,</span><span class="s13">293.66</span><span class="s1">,</span><span class="s13">329.63</span><span class="s1">,</span><span class="s13">349.23</span><span class="s1">,</span><span class="s13">392.00</span><span class="s1">,</span><span class="s13">440.00</span><span class="s1">,</span><span class="s13">493.88</span><span class="s1">,</span><span class="s13">523.25</span><span class="s1">]; </span><span class="s10">return</span><span class="s1"> scale[num-</span><span class="s13">1</span><span class="s1">]; };</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> playNoiseForBGM(time, duration, volume){ </span><span class="s10">if</span><span class="s1"> (audioCtx.state === </span><span class="s11">'suspended'</span><span class="s1">) audioCtx.resume(); </span><span class="s10">const</span><span class="s1"> buffer = audioCtx.createBuffer(</span><span class="s13">1</span><span class="s1">, audioCtx.sampleRate * duration, audioCtx.sampleRate); </span><span class="s10">const</span><span class="s1"> data = buffer.getChannelData(</span><span class="s13">0</span><span class="s1">); </span><span class="s10">for</span><span class="s1">(</span><span class="s10">let</span><span class="s1"> i=</span><span class="s13">0</span><span class="s1">;i&lt;data.length;i++) data[i] = (</span><span class="s14">Math</span><span class="s1">.random()*</span><span class="s13">2</span><span class="s1">-</span><span class="s13">1</span><span class="s1">); </span><span class="s10">const</span><span class="s1"> noise = audioCtx.createBufferSource(); noise.buffer = buffer; </span><span class="s10">const</span><span class="s1"> gain = audioCtx.createGain(); gain.gain.setValueAtTime(volume, time); gain.gain.exponentialRampToValueAtTime(</span><span class="s13">0.01</span><span class="s1">, time + duration); noise.connect(gain).connect(audioCtx.destination); noise.start(time); activeOscillators.push(noise); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> playNoteForBGM(freq, time, duration){ </span><span class="s10">if</span><span class="s1"> (audioCtx.state === </span><span class="s11">'suspended'</span><span class="s1">) audioCtx.resume(); </span><span class="s10">const</span><span class="s1"> osc = audioCtx.createOscillator(); osc.type = </span><span class="s11">"square"</span><span class="s1">; osc.frequency.value = freq; </span><span class="s10">const</span><span class="s1"> gain = audioCtx.createGain(); gain.gain.setValueAtTime(</span><span class="s13">0.15</span><span class="s1">, time); gain.gain.exponentialRampToValueAtTime(</span><span class="s13">0.01</span><span class="s1">, time + duration); osc.connect(gain).connect(audioCtx.destination); osc.start(time); osc.stop(time + duration); activeOscillators.push(osc); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> getCurrentBeatTime() { </span><span class="s10">let</span><span class="s1"> multiplier = </span><span class="s13">1.0</span><span class="s1"> + </span><span class="s14">Math</span><span class="s1">.min(score, </span><span class="s13">10000</span><span class="s1">) / </span><span class="s13">10000</span><span class="s1"> * </span><span class="s13">3.0</span><span class="s1">; </span><span class="s10">return</span><span class="s1"> </span><span class="s14">BASE_BEAT_TIME</span><span class="s1"> / multiplier; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> playBGMLoop(){ </span><span class="s10">if</span><span class="s1"> (!isBgmPlaying) </span><span class="s10">return</span><span class="s1">; </span><span class="s10">const</span><span class="s1"> start = audioCtx.currentTime; </span><span class="s10">const</span><span class="s1"> currentBeat = getCurrentBeatTime(); melody.forEach((note,i)=&gt;{ </span><span class="s10">const</span><span class="s1"> t = start + i * currentBeat; </span><span class="s10">if</span><span class="s1">(note &gt; </span><span class="s13">0</span><span class="s1">) playNoteForBGM(scaleToFreq(note), t, currentBeat); </span><span class="s10">else</span><span class="s1"> playNoiseForBGM(t, </span><span class="s13">0.03</span><span class="s1">, </span><span class="s13">0.1</span><span class="s1">); }); bgmTimeout = setTimeout(playBGMLoop, melody.length * currentBeat * </span><span class="s13">1000</span><span class="s1">); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> startBGM() { </span><span class="s10">if</span><span class="s1"> (isBgmPlaying) </span><span class="s10">return</span><span class="s1">; isBgmPlaying = </span><span class="s10">true</span><span class="s1">; </span><span class="s10">if</span><span class="s1"> (!audioCtx) audioCtx = </span><span class="s10">new</span><span class="s1"> (window.</span><span class="s14">AudioContext</span><span class="s1"> || window.webkitAudioContext)(); </span><span class="s10">if</span><span class="s1"> (audioCtx.state === </span><span class="s11">'suspended'</span><span class="s1">) audioCtx.resume(); playBGMLoop(); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> stopBGM() { isBgmPlaying = </span><span class="s10">false</span><span class="s1">; </span><span class="s10">if</span><span class="s1"> (bgmTimeout) clearTimeout(bgmTimeout); activeOscillators.forEach(node =&gt; { </span><span class="s10">try</span><span class="s1"> { node.stop(); } </span><span class="s10">catch</span><span class="s1">(e) {} }); activeOscillators = []; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> playGameOverSound() { </span><span class="s10">if</span><span class="s1"> (!audioCtx) audioCtx = </span><span class="s10">new</span><span class="s1"> (window.</span><span class="s14">AudioContext</span><span class="s1"> || window.webkitAudioContext)(); </span><span class="s10">if</span><span class="s1"> (audioCtx.state === </span><span class="s11">'suspended'</span><span class="s1">) audioCtx.resume(); </span><span class="s10">const</span><span class="s1"> osc = audioCtx.createOscillator(); </span><span class="s10">const</span><span class="s1"> gain = audioCtx.createGain(); osc.type = </span><span class="s11">'sawtooth'</span><span class="s1">; osc.connect(gain); gain.connect(audioCtx.destination); </span><span class="s10">const</span><span class="s1"> now = audioCtx.currentTime; osc.frequency.setValueAtTime(</span><span class="s13">800</span><span class="s1">, now); osc.frequency.exponentialRampToValueAtTime(</span><span class="s13">50</span><span class="s1">, now + </span><span class="s13">0.8</span><span class="s1">); gain.gain.setValueAtTime(</span><span class="s13">0.3</span><span class="s1">, now); gain.gain.exponentialRampToValueAtTime(</span><span class="s13">0.01</span><span class="s1">, now + </span><span class="s13">0.8</span><span class="s1">); osc.start(now); osc.stop(now + </span><span class="s13">0.8</span><span class="s1">); }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> loadResized(src, w, h) { </span><span class="s10">const</span><span class="s1"> wrapper = { img: </span><span class="s10">null</span><span class="s1">, ready: </span><span class="s10">false</span><span class="s1">, error: </span><span class="s10">false</span><span class="s1"> }; </span><span class="s10">const</span><span class="s1"> img = </span><span class="s10">new</span><span class="s1"> </span><span class="s14">Image</span><span class="s1">(); img.crossOrigin = </span><span class="s11">"Anonymous"</span><span class="s1">; img.src = src; img.onload = () =&gt; { </span><span class="s10">const</span><span class="s1"> offCanvas = document.createElement(</span><span class="s11">'canvas'</span><span class="s1">); offCanvas.width = w; offCanvas.height = h; </span><span class="s10">const</span><span class="s1"> offCtx = offCanvas.getContext(</span><span class="s11">'2d'</span><span class="s1">); offCtx.drawImage(img, </span><span class="s13">0</span><span class="s1">, </span><span class="s13">0</span><span class="s1">, w, h); wrapper.img = offCanvas; wrapper.ready = </span><span class="s10">true</span><span class="s1">; }; img.onerror = () =&gt; { wrapper.error = </span><span class="s10">true</span><span class="s1">; }; </span><span class="s10">return</span><span class="s1"> wrapper; }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> </span><span class="s14">P_W</span><span class="s1"> = </span><span class="s13">60</span><span class="s1">, </span><span class="s14">P_H</span><span class="s1"> = </span><span class="s13">60</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> playerAnim = { idle: [], run: [], jump: [], dead: </span><span class="s10">null</span><span class="s1">, squat: </span><span class="s10">null</span><span class="s1"> };</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">for</span><span class="s5">(</span><span class="s10">let</span><span class="s5"> i=</span><span class="s13">1</span><span class="s5">; i&lt;=</span><span class="s13">3</span><span class="s5">; i++) playerAnim.idle.push(loadResized(</span><span class="s1">`https://raw.githubusercontent.com/m-fukuda-blip/game/main/Taiki0</span><span class="s5">${i}</span><span class="s1">.png`</span><span class="s5">, </span><span class="s14">P_W</span><span class="s5">, </span><span class="s14">P_H</span><span class="s5">));</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">for</span><span class="s5">(</span><span class="s10">let</span><span class="s5"> i=</span><span class="s13">1</span><span class="s5">; i&lt;=</span><span class="s13">3</span><span class="s5">; i++) playerAnim.run.push(loadResized(</span><span class="s1">`https://raw.githubusercontent.com/m-fukuda-blip/game/main/Run0</span><span class="s5">${i}</span><span class="s1">.png`</span><span class="s5">, </span><span class="s14">P_W</span><span class="s5">, </span><span class="s14">P_H</span><span class="s5">));</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">for</span><span class="s5">(</span><span class="s10">let</span><span class="s5"> i=</span><span class="s13">1</span><span class="s5">; i&lt;=</span><span class="s13">3</span><span class="s5">; i++) playerAnim.jump.push(loadResized(</span><span class="s1">`https://raw.githubusercontent.com/m-fukuda-blip/game/main/Jump0</span><span class="s5">${i}</span><span class="s1">.png`</span><span class="s5">, </span><span class="s14">P_W</span><span class="s5">, </span><span class="s14">P_H</span><span class="s5">));</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span>playerAnim.dead = loadResized(</span><span class="s1">"https://raw.githubusercontent.com/m-fukuda-blip/game/main/Dead.png"</span><span class="s5">, </span><span class="s14">P_W</span><span class="s5">, </span><span class="s14">P_H</span><span class="s5">);</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span>playerAnim.squat = loadResized(</span><span class="s1">"https://raw.githubusercontent.com/m-fukuda-blip/game/main/squat.png"</span><span class="s5">, </span><span class="s14">P_W</span><span class="s5">, </span><span class="s14">P_H</span><span class="s5">);</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> enemyAnim = [], enemy2Anim = [];</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">for</span><span class="s5">(</span><span class="s10">let</span><span class="s5"> i=</span><span class="s13">1</span><span class="s5">; i&lt;=</span><span class="s13">2</span><span class="s5">; i++) { enemyAnim.push(loadResized(</span><span class="s1">`https://raw.githubusercontent.com/m-fukuda-blip/game/main/EnemyAction0</span><span class="s5">${i}</span><span class="s1">.png`</span><span class="s5">, </span><span class="s13">52</span><span class="s5">, </span><span class="s13">52</span><span class="s5">)); }</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">for</span><span class="s5">(</span><span class="s10">let</span><span class="s5"> i=</span><span class="s13">1</span><span class="s5">; i&lt;=</span><span class="s13">2</span><span class="s5">; i++) { enemy2Anim.push(loadResized(</span><span class="s1">`https://raw.githubusercontent.com/m-fukuda-blip/game/main/Enemy2Action0</span><span class="s5">${i}</span><span class="s1">.png`</span><span class="s5">, </span><span class="s13">52</span><span class="s5">, </span><span class="s13">52</span><span class="s5">)); }</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s5"> itemImgWrapper = loadResized(</span><span class="s1">"https://raw.githubusercontent.com/m-fukuda-blip/game/main/coin.png"</span><span class="s5">, </span><span class="s13">45</span><span class="s5">, </span><span class="s13">45</span><span class="s5">);</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s5"> capsuleImgWrapper = loadResized(</span><span class="s1">"https://raw.githubusercontent.com/m-fukuda-blip/game/main/capsule.png"</span><span class="s5">, </span><span class="s13">45</span><span class="s5">, </span><span class="s13">45</span><span class="s5">);</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s5"> mutekiImgWrapper = loadResized(</span><span class="s1">"https://raw.githubusercontent.com/m-fukuda-blip/game/main/muteki.png"</span><span class="s5">, </span><span class="s13">45</span><span class="s5">, </span><span class="s13">45</span><span class="s5">);</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s5"> jyamaImgWrapper = loadResized(</span><span class="s1">"https://raw.githubusercontent.com/m-fukuda-blip/game/main/jyama.png"</span><span class="s5">, </span><span class="s13">45</span><span class="s5">, </span><span class="s13">45</span><span class="s5">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> itemEffectAnim = [];</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">for</span><span class="s5">(</span><span class="s10">let</span><span class="s5"> i=</span><span class="s13">1</span><span class="s5">; i&lt;=</span><span class="s13">3</span><span class="s5">; i++) itemEffectAnim.push(loadResized(</span><span class="s1">`https://raw.githubusercontent.com/m-fukuda-blip/game/main/ItemAction0</span><span class="s5">${i}</span><span class="s1">.png`</span><span class="s5">, </span><span class="s13">45</span><span class="s5">, </span><span class="s13">45</span><span class="s5">));</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> cloudImgWrappers = [];</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">for</span><span class="s5">(</span><span class="s10">let</span><span class="s5"> i=</span><span class="s13">1</span><span class="s5">; i&lt;=</span><span class="s13">4</span><span class="s5">; i++) cloudImgWrappers.push(loadResized(</span><span class="s1">`https://raw.githubusercontent.com/m-fukuda-blip/game/main/cloud</span><span class="s5">${i}</span><span class="s1">.png`</span><span class="s5">, </span><span class="s13">170</span><span class="s5">, </span><span class="s13">120</span><span class="s5">));<span class="Apple-converted-space"> </span></span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s5"> mountainImgWrapper = loadResized(</span><span class="s1">"https://raw.githubusercontent.com/m-fukuda-blip/game/main/mountains.png"</span><span class="s5">, </span><span class="s13">3000</span><span class="s5">, </span><span class="s13">200</span><span class="s5">);</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s5"> buildingImgWrapper = loadResized(</span><span class="s1">"https://raw.githubusercontent.com/m-fukuda-blip/game/main/buildings.png"</span><span class="s5">, </span><span class="s13">3000</span><span class="s5">, </span><span class="s13">200</span><span class="s5">);</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s5"> </span><span class="s1">GRAVITY</span><span class="s5"> = </span><span class="s13">0.6</span><span class="s5">, </span><span class="s1">FRICTION</span><span class="s5"> = </span><span class="s13">0.8</span><span class="s5">, </span><span class="s1">BASE_GROUND_Y</span><span class="s5"> = </span><span class="s13">360</span><span class="s5">; <span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">let</span><span class="s1"> score = </span><span class="s13">0</span><span class="s1">, level = </span><span class="s13">1</span><span class="s1">, gameSpeed = </span><span class="s13">1.0</span><span class="s1">, hp = </span><span class="s13">3</span><span class="s1">, gameOver = </span><span class="s10">false</span><span class="s1">, isTitle = </span><span class="s10">true</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">let</span><span class="s1"> frameCount = </span><span class="s13">0</span><span class="s1">, nextEnemySpawn = </span><span class="s13">0</span><span class="s1">, nextItemSpawn = </span><span class="s13">0</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">let</span><span class="s1"> facingRight = </span><span class="s10">true</span><span class="s1">, isInvincible = </span><span class="s10">false</span><span class="s1">, invincibleTimer = </span><span class="s13">0</span><span class="s1">, terrainSegments = [];</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">let</span><span class="s1"> superMode = </span><span class="s10">false</span><span class="s1">, superModeTimer = </span><span class="s13">0</span><span class="s1">, slowMode = </span><span class="s10">false</span><span class="s1">, slowModeTimer = </span><span class="s13">0</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">let</span><span class="s1"> floatingTexts = [], autoRestartTimer = </span><span class="s10">null</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">let</span><span class="s1"> cameraX = </span><span class="s13">0</span><span class="s1">, lastGeneratedX = </span><span class="s13">0</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">let</span><span class="s1"> platforms = [], checkpoints = [], nextCheckpointDist = </span><span class="s13">800</span><span class="s1"> * </span><span class="s13">10</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> player = {<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>x: </span><span class="s13">200</span><span class="s1">, y: </span><span class="s13">0</span><span class="s1">, width: </span><span class="s13">60</span><span class="s1">, height: </span><span class="s13">60</span><span class="s1">, speed: </span><span class="s13">7</span><span class="s1">, dx: </span><span class="s13">0</span><span class="s1">, dy: </span><span class="s13">0</span><span class="s1">,<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>jumping: </span><span class="s10">false</span><span class="s1">, jumpCount: </span><span class="s13">0</span><span class="s1">, maxJump: </span><span class="s13">2</span><span class="s1">,</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>state: </span><span class="s11">'idle'</span><span class="s1">, animIndex: </span><span class="s13">0</span><span class="s1">, animTimer: </span><span class="s13">0</span><span class="s1">, animSpeedIdle: </span><span class="s13">15</span><span class="s1">, animSpeedRun: </span><span class="s13">8</span><span class="s1">, idlePingPong: </span><span class="s13">1</span><span class="s1">, combo: </span><span class="s13">0</span><span class="s1"><span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">   </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">let</span><span class="s1"> enemies = [], items = [], clouds = [];</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s1"> keys = { right: </span><span class="s10">false</span><span class="s1">, left: </span><span class="s10">false</span><span class="s1">, up: </span><span class="s10">false</span><span class="s1">, down: </span><span class="s10">false</span><span class="s1"> };<span class="Apple-converted-space"> </span></span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s1">// ★重要: Python側でここが置換される</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">  </span></span><span class="s10">const</span><span class="s5"> </span><span class="s14">API_URL</span><span class="s5"> = </span><span class="s1">"{GAS_API_URL}"</span><span class="s5">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">  </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">let</span><span class="s1"> globalRankings = [];</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">async</span><span class="s1"> </span><span class="s10">function</span><span class="s1"> fetchRankings() { </span><span class="s10">try</span><span class="s1"> { </span><span class="s10">const</span><span class="s1"> response = </span><span class="s10">await</span><span class="s1"> fetch(</span><span class="s14">API_URL</span><span class="s1">); </span><span class="s10">return</span><span class="s1"> </span><span class="s10">await</span><span class="s1"> response.json(); } </span><span class="s10">catch</span><span class="s1"> (e) { </span><span class="s10">return</span><span class="s1"> []; } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">async</span><span class="s1"> </span><span class="s10">function</span><span class="s1"> sendScore(name, score) { </span><span class="s10">try</span><span class="s1"> { </span><span class="s10">await</span><span class="s1"> fetch(</span><span class="s14">API_URL</span><span class="s1">, { method: </span><span class="s11">'POST'</span><span class="s1">, body: </span><span class="s14">JSON</span><span class="s1">.stringify({ name: name, score: score }) }); } </span><span class="s10">catch</span><span class="s1"> (e) {} }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>fetchRankings().then(data =&gt; { globalRankings = data; });</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> checkRankIn(currentScore) { </span><span class="s10">if</span><span class="s1"> (globalRankings.length &lt; </span><span class="s13">10</span><span class="s1">) </span><span class="s10">return</span><span class="s1"> </span><span class="s10">true</span><span class="s1">; </span><span class="s10">return</span><span class="s1"> currentScore &gt; globalRankings[globalRankings.length - </span><span class="s13">1</span><span class="s1">].score; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> startAutoRestartCountdown() {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">let</span><span class="s1"> count = </span><span class="s13">5</span><span class="s1">; autoRestartMsg.style.display = </span><span class="s11">'block'</span><span class="s1">; autoRestartMsg.innerText = </span><span class="s11">`Restarting in </span><span class="s1">${count}</span><span class="s11">...`</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">if</span><span class="s1"> (autoRestartTimer) clearInterval(autoRestartTimer);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>autoRestartTimer = setInterval(() =&gt; { count--; </span><span class="s10">if</span><span class="s1"> (count &gt; </span><span class="s13">0</span><span class="s1">) autoRestartMsg.innerText = </span><span class="s11">`Restarting in </span><span class="s1">${count}</span><span class="s11">...`</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> { clearInterval(autoRestartTimer); resetGame(); } }, </span><span class="s13">1000</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">async</span><span class="s1"> </span><span class="s10">function</span><span class="s1"> submitScore() {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">const</span><span class="s1"> name = nameInput.value.trim() || </span><span class="s11">"NO NAME"</span><span class="s1">; nameInput.disabled = </span><span class="s10">true</span><span class="s1">; submitBtn.disabled = </span><span class="s10">true</span><span class="s1">; loadingMsg.style.display = </span><span class="s11">'block'</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">await</span><span class="s1"> sendScore(name, score); globalRankings = </span><span class="s10">await</span><span class="s1"> fetchRankings();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>loadingMsg.style.display = </span><span class="s11">'none'</span><span class="s1">; nameInput.disabled = </span><span class="s10">false</span><span class="s1">; submitBtn.disabled = </span><span class="s10">false</span><span class="s1">; inputSection.style.display = </span><span class="s11">'none'</span><span class="s1">; showRankingTable(globalRankings);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (isMobile) startAutoRestartCountdown();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> showRankingTable(rankings) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (!rankings) rankings = globalRankings; rankingBody.innerHTML = </span><span class="s11">""</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> i = </span><span class="s13">0</span><span class="s1">; i &lt; </span><span class="s13">10</span><span class="s1">; i++) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> r = rankings[i]; </span><span class="s10">let</span><span class="s1"> row = document.createElement(</span><span class="s11">'tr'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (r) row.innerHTML = </span><span class="s11">`&lt;td class="rank-col"&gt;</span><span class="s1">${i + </span><span class="s13">1</span><span class="s1">}</span><span class="s11">&lt;/td&gt;&lt;td style="</span><span class="s1">${r.score === score &amp;&amp; r.name === nameInput.value ? </span><span class="s11">"color: yellow; font-weight:bold;"</span><span class="s1"> : </span><span class="s11">""</span><span class="s1">}</span><span class="s11">"&gt;</span><span class="s1">${r.name}</span><span class="s11">&lt;/td&gt;&lt;td class="score-col"&gt;</span><span class="s1">${r.score}</span><span class="s11">&lt;/td&gt;`</span><span class="s1">;</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s10">else</span><span class="s5"> row.innerHTML = </span><span class="s1">`&lt;td class="rank-col"&gt;</span><span class="s5">${i + </span><span class="s13">1</span><span class="s5">}</span><span class="s1">&lt;/td&gt;&lt;td&gt;---&lt;/td&gt;&lt;td class="score-col"&gt;0&lt;/td&gt;`</span><span class="s5">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>rankingBody.appendChild(row);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> handleGameOver() {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>gameOver = </span><span class="s10">true</span><span class="s1">; player.state = </span><span class="s11">'dead'</span><span class="s1">; stopBGM(); playGameOverSound(); addShake(</span><span class="s13">15</span><span class="s1">, </span><span class="s13">20</span><span class="s1">);<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>overlay.style.display = </span><span class="s11">'block'</span><span class="s1">; finalScoreDisplay.innerText = </span><span class="s11">"Final Score: "</span><span class="s1"> + score;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>nameInput.value = </span><span class="s11">""</span><span class="s1">; rankingBody.innerHTML = </span><span class="s11">""</span><span class="s1">; rankLoading.style.display = </span><span class="s11">"block"</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>fetchRankings().then(data =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>globalRankings = data; rankLoading.style.display = </span><span class="s11">"none"</span><span class="s1">; showRankingTable(globalRankings);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (score &gt; </span><span class="s13">0</span><span class="s1"> &amp;&amp; checkRankIn(score)) { inputSection.style.display = </span><span class="s11">'block'</span><span class="s1">; nameInput.focus(); }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">else</span><span class="s1"> { inputSection.style.display = </span><span class="s11">'none'</span><span class="s1">; </span><span class="s10">if</span><span class="s1"> (isMobile) startAutoRestartCountdown(); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> playSound(type) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (!audioCtx) audioCtx = </span><span class="s10">new</span><span class="s1"> (window.</span><span class="s14">AudioContext</span><span class="s1"> || window.webkitAudioContext)(); </span><span class="s10">if</span><span class="s1"> (audioCtx.state === </span><span class="s11">'suspended'</span><span class="s1">) audioCtx.resume();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">const</span><span class="s1"> osc = audioCtx.createOscillator(); </span><span class="s10">const</span><span class="s1"> gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); </span><span class="s10">const</span><span class="s1"> now = audioCtx.currentTime;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (type === </span><span class="s11">'jump'</span><span class="s1">) { osc.type = </span><span class="s11">'square'</span><span class="s1">; osc.frequency.setValueAtTime(</span><span class="s13">150</span><span class="s1">, now); osc.frequency.linearRampToValueAtTime(</span><span class="s13">300</span><span class="s1">, now + </span><span class="s13">0.1</span><span class="s1">); gain.gain.setValueAtTime(</span><span class="s13">0.1</span><span class="s1">, now); gain.gain.exponentialRampToValueAtTime(</span><span class="s13">0.01</span><span class="s1">, now + </span><span class="s13">0.1</span><span class="s1">); osc.start(now); osc.stop(now + </span><span class="s13">0.1</span><span class="s1">); }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (type === </span><span class="s11">'coin'</span><span class="s1">) { osc.type = </span><span class="s11">'sine'</span><span class="s1">; osc.frequency.setValueAtTime(</span><span class="s13">1200</span><span class="s1">, now); osc.frequency.setValueAtTime(</span><span class="s13">1600</span><span class="s1">, now + </span><span class="s13">0.05</span><span class="s1">); gain.gain.setValueAtTime(</span><span class="s13">0.1</span><span class="s1">, now); gain.gain.exponentialRampToValueAtTime(</span><span class="s13">0.01</span><span class="s1">, now + </span><span class="s13">0.2</span><span class="s1">); osc.start(now); osc.stop(now + </span><span class="s13">0.2</span><span class="s1">); }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (type === </span><span class="s11">'hit'</span><span class="s1">) { osc.type = </span><span class="s11">'sawtooth'</span><span class="s1">; osc.frequency.setValueAtTime(</span><span class="s13">100</span><span class="s1">, now); osc.frequency.linearRampToValueAtTime(</span><span class="s13">50</span><span class="s1">, now + </span><span class="s13">0.3</span><span class="s1">); gain.gain.setValueAtTime(</span><span class="s13">0.2</span><span class="s1">, now); gain.gain.exponentialRampToValueAtTime(</span><span class="s13">0.01</span><span class="s1">, now + </span><span class="s13">0.3</span><span class="s1">); osc.start(now); osc.stop(now + </span><span class="s13">0.3</span><span class="s1">); }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (type === </span><span class="s11">'heal'</span><span class="s1">) { osc.type = </span><span class="s11">'sine'</span><span class="s1">; osc.frequency.setValueAtTime(</span><span class="s13">400</span><span class="s1">, now); osc.frequency.linearRampToValueAtTime(</span><span class="s13">800</span><span class="s1">, now + </span><span class="s13">0.2</span><span class="s1">); gain.gain.setValueAtTime(</span><span class="s13">0.1</span><span class="s1">, now); gain.gain.linearRampToValueAtTime(</span><span class="s13">0</span><span class="s1">, now + </span><span class="s13">0.3</span><span class="s1">); osc.start(now); osc.stop(now + </span><span class="s13">0.3</span><span class="s1">); }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (type === </span><span class="s11">'powerup'</span><span class="s1">) { osc.type = </span><span class="s11">'square'</span><span class="s1">; osc.frequency.setValueAtTime(</span><span class="s13">440</span><span class="s1">, now); osc.frequency.setValueAtTime(</span><span class="s13">880</span><span class="s1">, now + </span><span class="s13">0.1</span><span class="s1">); gain.gain.setValueAtTime(</span><span class="s13">0.1</span><span class="s1">, now); gain.gain.linearRampToValueAtTime(</span><span class="s13">0</span><span class="s1">, now + </span><span class="s13">0.5</span><span class="s1">); osc.start(now); osc.stop(now + </span><span class="s13">0.5</span><span class="s1">); }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (type === </span><span class="s11">'bad'</span><span class="s1">) { osc.type = </span><span class="s11">'sawtooth'</span><span class="s1">; osc.frequency.setValueAtTime(</span><span class="s13">300</span><span class="s1">, now); osc.frequency.linearRampToValueAtTime(</span><span class="s13">150</span><span class="s1">, now + </span><span class="s13">0.3</span><span class="s1">); gain.gain.setValueAtTime(</span><span class="s13">0.1</span><span class="s1">, now); gain.gain.linearRampToValueAtTime(</span><span class="s13">0</span><span class="s1">, now + </span><span class="s13">0.3</span><span class="s1">); osc.start(now); osc.stop(now + </span><span class="s13">0.3</span><span class="s1">); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (type === </span><span class="s11">'gate'</span><span class="s1">) { osc.type = </span><span class="s11">'sine'</span><span class="s1">; osc.frequency.setValueAtTime(</span><span class="s13">800</span><span class="s1">, now); osc.frequency.linearRampToValueAtTime(</span><span class="s13">1200</span><span class="s1">, now + </span><span class="s13">0.3</span><span class="s1">); gain.gain.setValueAtTime(</span><span class="s13">0.2</span><span class="s1">, now); gain.gain.linearRampToValueAtTime(</span><span class="s13">0</span><span class="s1">, now + </span><span class="s13">0.4</span><span class="s1">); osc.start(now); osc.stop(now + </span><span class="s13">0.4</span><span class="s1">); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> doJump() {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">if</span><span class="s1"> (!gameOver &amp;&amp; !isTitle) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s10">if</span><span class="s1"> (!player.jumping || player.jumpCount &lt; player.maxJump) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">              </span>player.jumping = </span><span class="s10">true</span><span class="s1">; player.dy = -</span><span class="s13">12</span><span class="s1">; player.jumpCount++; playSound(</span><span class="s11">'jump'</span><span class="s1">); startBGM();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>document.addEventListener(</span><span class="s11">'keydown'</span><span class="s1">, (e) =&gt; {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (document.activeElement === nameInput) { </span><span class="s10">if</span><span class="s1"> (e.key === </span><span class="s11">'Enter'</span><span class="s1"> &amp;&amp; !submitBtn.disabled) submitScore(); </span><span class="s10">return</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (player.state === </span><span class="s11">'dead'</span><span class="s1"> &amp;&amp; e.code !== </span><span class="s11">'KeyR'</span><span class="s1">) </span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (e.code === </span><span class="s11">'KeyF'</span><span class="s1">) { </span><span class="s10">if</span><span class="s1"> (!document.fullscreenElement) document.documentElement.requestFullscreen(); </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (document.exitFullscreen) document.exitFullscreen(); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> ([</span><span class="s11">'KeyW'</span><span class="s1">, </span><span class="s11">'KeyA'</span><span class="s1">, </span><span class="s11">'KeyS'</span><span class="s1">, </span><span class="s11">'KeyD'</span><span class="s1">, </span><span class="s11">'KeyR'</span><span class="s1">, </span><span class="s11">'KeyF'</span><span class="s1">].includes(e.code)) { e.preventDefault(); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (e.code === </span><span class="s11">'KeyD'</span><span class="s1">) { keys.right = </span><span class="s10">true</span><span class="s1">; facingRight = </span><span class="s10">true</span><span class="s1">; startBGM(); } </span><span class="s10">if</span><span class="s1"> (e.code === </span><span class="s11">'KeyA'</span><span class="s1">) { keys.left = </span><span class="s10">true</span><span class="s1">; facingRight = </span><span class="s10">false</span><span class="s1">; startBGM(); } </span><span class="s10">if</span><span class="s1"> (e.code === </span><span class="s11">'KeyS'</span><span class="s1">) { keys.down = </span><span class="s10">true</span><span class="s1">; startBGM(); } </span><span class="s10">if</span><span class="s1"> (e.code === </span><span class="s11">'KeyW'</span><span class="s1">) { doJump(); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (e.code === </span><span class="s11">'KeyR'</span><span class="s1"> &amp;&amp; gameOver) resetGame();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>});</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>document.addEventListener(</span><span class="s11">'keyup'</span><span class="s1">, (e) =&gt; { </span><span class="s10">if</span><span class="s1"> (e.code === </span><span class="s11">'KeyD'</span><span class="s1">) keys.right = </span><span class="s10">false</span><span class="s1">; </span><span class="s10">if</span><span class="s1"> (e.code === </span><span class="s11">'KeyA'</span><span class="s1">) keys.left = </span><span class="s10">false</span><span class="s1">; </span><span class="s10">if</span><span class="s1"> (e.code === </span><span class="s11">'KeyS'</span><span class="s1">) keys.down = </span><span class="s10">false</span><span class="s1">; });</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> updateTerrain() {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">const</span><span class="s1"> deleteThreshold = cameraX - </span><span class="s13">200</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> i = </span><span class="s13">0</span><span class="s1">; i &lt; terrainSegments.length; i++) { </span><span class="s10">if</span><span class="s1"> (terrainSegments[i].x + terrainSegments[i].width &lt; deleteThreshold) { terrainSegments.splice(i, </span><span class="s13">1</span><span class="s1">); i--; } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> i = </span><span class="s13">0</span><span class="s1">; i &lt; platforms.length; i++) { </span><span class="s10">if</span><span class="s1"> (platforms[i].x + platforms[i].width &lt; deleteThreshold) { platforms.splice(i, </span><span class="s13">1</span><span class="s1">); i--; } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> i = </span><span class="s13">0</span><span class="s1">; i &lt; checkpoints.length; i++) { </span><span class="s10">if</span><span class="s1"> (checkpoints[i].x + </span><span class="s13">100</span><span class="s1"> &lt; deleteThreshold) { checkpoints.splice(i, </span><span class="s13">1</span><span class="s1">); i--; } }</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">       </span></span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s1">// ★修正: 先読み生成距離を広げる</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">const</span><span class="s1"> generateThreshold = cameraX + canvas.width + </span><span class="s13">800</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">while</span><span class="s1"> (lastGeneratedX &lt; generateThreshold) { generateNextSegment(); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">if</span><span class="s1"> (lastGeneratedX &gt; nextCheckpointDist) { checkpoints.push({ x: nextCheckpointDist, passed: </span><span class="s10">false</span><span class="s1"> }); nextCheckpointDist += </span><span class="s13">800</span><span class="s1"> * </span><span class="s13">10</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> generateNextSegment() {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">if</span><span class="s1"> (terrainSegments.length === </span><span class="s13">0</span><span class="s1">) { terrainSegments.push({ x: </span><span class="s13">0</span><span class="s1">, width: </span><span class="s13">800</span><span class="s1">, topY: </span><span class="s14">BASE_GROUND_Y</span><span class="s1">, level: </span><span class="s13">0</span><span class="s1"> }); lastGeneratedX = </span><span class="s13">800</span><span class="s1">; </span><span class="s10">return</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">let</span><span class="s1"> prevSeg = terrainSegments[terrainSegments.length - </span><span class="s13">1</span><span class="s1">];</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">let</span><span class="s1"> gapWidth = </span><span class="s13">0</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">if</span><span class="s1"> (</span><span class="s14">Math</span><span class="s1">.random() &lt; </span><span class="s13">0.25</span><span class="s1"> &amp;&amp; prevSeg.width &gt; </span><span class="s13">100</span><span class="s1">) gapWidth = </span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">100</span><span class="s1"> + </span><span class="s13">80</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">let</span><span class="s1"> newX = lastGeneratedX + gapWidth; </span><span class="s10">let</span><span class="s1"> width = </span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">200</span><span class="s1"> + </span><span class="s13">150</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">      </span></span><span class="s10">const</span><span class="s5"> </span><span class="s1">SEG_HEIGHTS</span><span class="s5"> = [</span><span class="s1">BASE_GROUND_Y</span><span class="s5">, </span><span class="s1">BASE_GROUND_Y</span><span class="s5"> - </span><span class="s13">50</span><span class="s5">, </span><span class="s1">BASE_GROUND_Y</span><span class="s5"> - </span><span class="s13">100</span><span class="s5">];</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">let</span><span class="s1"> prevLevel = prevSeg.level !== </span><span class="s10">undefined</span><span class="s1"> ? prevSeg.level : </span><span class="s13">0</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">let</span><span class="s1"> delta = </span><span class="s14">Math</span><span class="s1">.floor(</span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">3</span><span class="s1">) - </span><span class="s13">1</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">let</span><span class="s1"> newLevel = </span><span class="s14">Math</span><span class="s1">.min(</span><span class="s13">2</span><span class="s1">, </span><span class="s14">Math</span><span class="s1">.max(</span><span class="s13">0</span><span class="s1">, prevLevel + delta));</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">let</span><span class="s1"> topY = </span><span class="s14">SEG_HEIGHTS</span><span class="s1">[newLevel];</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>terrainSegments.push({ x: newX, width: width, topY: topY, level: newLevel });</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>lastGeneratedX = newX + width;</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">if</span><span class="s1"> (</span><span class="s14">Math</span><span class="s1">.random() &lt; </span><span class="s13">0.3</span><span class="s1">) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s10">let</span><span class="s1"> pW = player.width * (</span><span class="s13">3</span><span class="s1"> + </span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">2</span><span class="s1">); </span><span class="s10">let</span><span class="s1"> pX = newX + </span><span class="s14">Math</span><span class="s1">.random() * (width - pW); </span><span class="s10">let</span><span class="s1"> pY = topY - </span><span class="s13">100</span><span class="s1"> - </span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">80</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s10">if</span><span class="s1"> (pY &lt; </span><span class="s13">100</span><span class="s1">) pY = </span><span class="s13">100</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span>platforms.push({ x: pX, y: pY, width: pW, height: </span><span class="s13">20</span><span class="s1"> });</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s10">if</span><span class="s1"> (</span><span class="s14">Math</span><span class="s1">.random() &lt; </span><span class="s13">0.5</span><span class="s1">) spawnEnemyOnTerrain(pX, pW, pY);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">if</span><span class="s1"> (gapWidth === </span><span class="s13">0</span><span class="s1"> &amp;&amp; width &gt; </span><span class="s13">100</span><span class="s1">) { </span><span class="s10">if</span><span class="s1"> (</span><span class="s14">Math</span><span class="s1">.random() &lt; </span><span class="s13">1.0</span><span class="s1">) spawnEnemyOnTerrain(newX, width, topY); </span><span class="s10">if</span><span class="s1"> (</span><span class="s14">Math</span><span class="s1">.random() &lt; </span><span class="s13">0.8</span><span class="s1">) spawnItemOnTerrain(newX, width, topY); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">   </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> spawnEnemyOnTerrain(tx, tw, ty) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">let</span><span class="s1"> type = </span><span class="s14">Math</span><span class="s1">.random() &lt; </span><span class="s13">0.5</span><span class="s1"> ? </span><span class="s11">'ground'</span><span class="s1"> : </span><span class="s11">'flying'</span><span class="s1">; </span><span class="s10">let</span><span class="s1"> speedBase = </span><span class="s13">2</span><span class="s1"> + level * </span><span class="s13">0.05</span><span class="s1">; </span><span class="s10">let</span><span class="s1"> ex = tx + </span><span class="s14">Math</span><span class="s1">.random() * (tw - </span><span class="s13">60</span><span class="s1">) + </span><span class="s13">30</span><span class="s1">; </span><span class="s10">let</span><span class="s1"> ey = ty - </span><span class="s13">52</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">if</span><span class="s1"> (type === </span><span class="s11">'flying'</span><span class="s1">) ey = ty - </span><span class="s13">100</span><span class="s1"> - </span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">100</span><span class="s1">; </span><span class="s10">if</span><span class="s1"> (score &gt;= </span><span class="s13">2000</span><span class="s1"> &amp;&amp; </span><span class="s14">Math</span><span class="s1">.random() &lt; </span><span class="s13">0.3</span><span class="s1">) { type = </span><span class="s11">'hard'</span><span class="s1">; speedBase += </span><span class="s13">2</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>enemies.push({ x: ex, y: ey, width: </span><span class="s13">52</span><span class="s1">, height: </span><span class="s13">52</span><span class="s1">, dx: -speedBase, dy: </span><span class="s13">0</span><span class="s1">, type: type, angle: </span><span class="s13">0</span><span class="s1">, animIndex: </span><span class="s13">0</span><span class="s1">, animTimer: </span><span class="s13">0</span><span class="s1"> });</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> spawnItemOnTerrain(tx, tw, ty) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">const</span><span class="s1"> r = </span><span class="s14">Math</span><span class="s1">.random(); </span><span class="s10">let</span><span class="s1"> type = </span><span class="s11">'coin'</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">if</span><span class="s1"> (r &lt; </span><span class="s13">0.005</span><span class="s1">) type = </span><span class="s11">'star'</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (r &lt; </span><span class="s13">0.035</span><span class="s1">) type = </span><span class="s11">'trap'</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (r &lt; </span><span class="s13">0.045</span><span class="s1">) type = </span><span class="s11">'heal'</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> type = </span><span class="s11">'coin'</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">let</span><span class="s1"> ix = tx + </span><span class="s14">Math</span><span class="s1">.random() * (tw - </span><span class="s13">50</span><span class="s1">) + </span><span class="s13">25</span><span class="s1">; </span><span class="s10">let</span><span class="s1"> iy = ty - </span><span class="s13">45</span><span class="s1"> - </span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">100</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span>items.push({ x: ix, y: iy, width: </span><span class="s13">45</span><span class="s1">, height: </span><span class="s13">45</span><span class="s1">, dx: </span><span class="s13">0</span><span class="s1">, isCollected: </span><span class="s10">false</span><span class="s1">, animIndex: </span><span class="s13">0</span><span class="s1">, animTimer: </span><span class="s13">0</span><span class="s1">, type: type });<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">   </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> getGroundYUnderPlayer() {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">let</span><span class="s1"> groundY = </span><span class="s10">null</span><span class="s1">; </span><span class="s10">let</span><span class="s1"> centerX = player.x + player.width / </span><span class="s13">2</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> seg </span><span class="s10">of</span><span class="s1"> terrainSegments) { </span><span class="s10">if</span><span class="s1"> (centerX &gt; seg.x &amp;&amp; centerX &lt; seg.x + seg.width) { </span><span class="s10">if</span><span class="s1"> (groundY === </span><span class="s10">null</span><span class="s1"> || seg.topY &lt; groundY) groundY = seg.topY; } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> p </span><span class="s10">of</span><span class="s1"> platforms) { </span><span class="s10">if</span><span class="s1"> (centerX &gt; p.x &amp;&amp; centerX &lt; p.x + p.width) { </span><span class="s10">if</span><span class="s1"> (player.y + player.height &lt;= p.y + </span><span class="s13">20</span><span class="s1">) { </span><span class="s10">if</span><span class="s1"> (groundY === </span><span class="s10">null</span><span class="s1"> || p.y &lt; groundY) groundY = p.y; } } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">return</span><span class="s1"> groundY;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> getGroundYAtX(x) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">let</span><span class="s1"> groundY = </span><span class="s10">null</span><span class="s1">; </span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> seg </span><span class="s10">of</span><span class="s1"> terrainSegments) { </span><span class="s10">if</span><span class="s1"> (x &gt;= seg.x &amp;&amp; x &lt;= seg.x + seg.width) { </span><span class="s10">if</span><span class="s1"> (groundY === </span><span class="s10">null</span><span class="s1"> || seg.topY &lt; groundY) groundY = seg.topY; } } </span><span class="s10">return</span><span class="s1"> groundY;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> initClouds() { clouds = []; </span><span class="s10">for</span><span class="s1">(</span><span class="s10">let</span><span class="s1"> i=</span><span class="s13">0</span><span class="s1">; i&lt;</span><span class="s13">8</span><span class="s1">; i++) { clouds.push({ x: </span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">1200</span><span class="s1">, y: </span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">200</span><span class="s1">, speed: </span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">0.3</span><span class="s1"> + </span><span class="s13">0.1</span><span class="s1">, imgIndex: </span><span class="s14">Math</span><span class="s1">.floor(</span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">4</span><span class="s1">) }); } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> updateClouds() {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1">(</span><span class="s10">let</span><span class="s1"> c </span><span class="s10">of</span><span class="s1"> clouds) { c.x -= c.speed; </span><span class="s10">if</span><span class="s1">(c.x &lt; </span><span class="s13">0.2</span><span class="s1"> * cameraX - </span><span class="s13">200</span><span class="s1">) { c.x = </span><span class="s13">0.2</span><span class="s1"> * cameraX + canvas.width + </span><span class="s13">200</span><span class="s1"> + </span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">200</span><span class="s1">; c.y = </span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">150</span><span class="s1">; c.imgIndex = </span><span class="s14">Math</span><span class="s1">.floor(</span><span class="s14">Math</span><span class="s1">.random() * </span><span class="s13">4</span><span class="s1">); } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> updateLevel() { </span><span class="s10">const</span><span class="s1"> newLevel = </span><span class="s14">Math</span><span class="s1">.floor(score / </span><span class="s13">500</span><span class="s1">) + </span><span class="s13">1</span><span class="s1">; </span><span class="s10">if</span><span class="s1"> (newLevel &gt; level) { level = newLevel; gameSpeed = </span><span class="s13">1.0</span><span class="s1"> + (level * </span><span class="s13">0.05</span><span class="s1">); levelEl.innerText = level; </span><span class="s10">if</span><span class="s1">(hp &lt; </span><span class="s13">3</span><span class="s1">) { hp++; updateHearts(); } } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> updateHearts() { </span><span class="s10">let</span><span class="s1"> h = </span><span class="s11">""</span><span class="s1">; </span><span class="s10">for</span><span class="s1">(</span><span class="s10">let</span><span class="s1"> i=</span><span class="s13">0</span><span class="s1">; i&lt;hp; i++) h += </span><span class="s11">"❤️"</span><span class="s1">; heartsEl.innerText = h; }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> resetGame() {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (autoRestartTimer) clearInterval(autoRestartTimer); autoRestartMsg.style.display = </span><span class="s11">'none'</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>player.x = </span><span class="s13">200</span><span class="s1">; player.y = </span><span class="s13">0</span><span class="s1">; player.dx = </span><span class="s13">0</span><span class="s1">; player.dy = </span><span class="s13">0</span><span class="s1">; cameraX = </span><span class="s13">0</span><span class="s1">; lastGeneratedX = </span><span class="s13">0</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>player.state = </span><span class="s11">'idle'</span><span class="s1">; player.animIndex = </span><span class="s13">0</span><span class="s1">; player.animTimer = </span><span class="s13">0</span><span class="s1">; player.idlePingPong = </span><span class="s13">1</span><span class="s1">; player.combo = </span><span class="s13">0</span><span class="s1">; player.jumpCount = </span><span class="s13">0</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>score = </span><span class="s13">0</span><span class="s1">; level = </span><span class="s13">1</span><span class="s1">; gameSpeed = </span><span class="s13">1.0</span><span class="s1">; hp = </span><span class="s13">3</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>enemies = []; items = []; floatingTexts = []; particles = []; terrainSegments = []; platforms = []; checkpoints = []; nextCheckpointDist = </span><span class="s13">800</span><span class="s1"> * </span><span class="s13">10</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>gameOver = </span><span class="s10">false</span><span class="s1">; frameCount = </span><span class="s13">0</span><span class="s1">; isInvincible = </span><span class="s10">false</span><span class="s1">; nextEnemySpawn = </span><span class="s13">0</span><span class="s1">; nextItemSpawn = </span><span class="s13">0</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>scoreEl.innerText = score; levelEl.innerText = level;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>superMode = </span><span class="s10">false</span><span class="s1">; superModeTimer = </span><span class="s13">0</span><span class="s1">; slowMode = </span><span class="s10">false</span><span class="s1">; slowModeTimer = </span><span class="s13">0</span><span class="s1">; statusMsgEl.innerText = </span><span class="s11">""</span><span class="s1">;</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>isTitle = </span><span class="s10">true</span><span class="s1">; titleScreen.style.display = </span><span class="s11">'flex'</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>titleImg.style.animation = </span><span class="s11">'none'</span><span class="s1">; </span><span class="s10">void</span><span class="s1"> titleImg.offsetWidth; titleImg.style.animation = </span><span class="s11">'slideUpFade 2s forwards'</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>startText.style.opacity = </span><span class="s11">'0'</span><span class="s1">; startText.style.animation = </span><span class="s11">'none'</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>setTimeout(() =&gt; { startText.style.animation = </span><span class="s11">'blinkFade 0.5s forwards'</span><span class="s1">; setTimeout(() =&gt; { titleScreen.style.display = </span><span class="s11">'none'</span><span class="s1">; isTitle = </span><span class="s10">false</span><span class="s1">; }, </span><span class="s13">1000</span><span class="s1">); }, </span><span class="s13">2000</span><span class="s1">);</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>updateHearts(); initClouds(); checkOrientationAndResize(); updateTerrain();<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">const</span><span class="s1"> startGround = getGroundYUnderPlayer(); </span><span class="s10">const</span><span class="s1"> gY = startGround !== </span><span class="s10">null</span><span class="s1"> ? startGround : </span><span class="s14">BASE_GROUND_Y</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>player.y = gY - player.height; overlay.style.display = </span><span class="s11">'none'</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> updatePlayerAnimation() {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">const</span><span class="s1"> prevState = player.state;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (hp &lt;= </span><span class="s13">0</span><span class="s1">) player.state = </span><span class="s11">'dead'</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (player.jumping) player.state = </span><span class="s11">'jump'</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (keys.down) player.state = </span><span class="s11">'squat'</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (keys.right || keys.left) player.state = </span><span class="s11">'run'</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> player.state = </span><span class="s11">'idle'</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (player.state !== prevState) { player.animTimer = </span><span class="s13">0</span><span class="s1">; player.animIndex = </span><span class="s13">0</span><span class="s1">; player.idlePingPong = </span><span class="s13">1</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>player.animTimer++;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">switch</span><span class="s1"> (player.state) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">case</span><span class="s1"> </span><span class="s11">'idle'</span><span class="s1">: </span><span class="s10">if</span><span class="s1"> (player.animTimer &gt; player.animSpeedIdle) { player.animIndex += player.idlePingPong; </span><span class="s10">if</span><span class="s1"> (player.animIndex &gt;= </span><span class="s13">2</span><span class="s1">) player.idlePingPong = -</span><span class="s13">1</span><span class="s1">; </span><span class="s10">if</span><span class="s1"> (player.animIndex &lt;= </span><span class="s13">0</span><span class="s1">) player.idlePingPong = </span><span class="s13">1</span><span class="s1">; player.animTimer = </span><span class="s13">0</span><span class="s1">; } </span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">case</span><span class="s1"> </span><span class="s11">'run'</span><span class="s1">: </span><span class="s10">if</span><span class="s1"> (player.animTimer &gt; player.animSpeedRun) { player.animIndex = (player.animIndex + </span><span class="s13">1</span><span class="s1">) % </span><span class="s13">3</span><span class="s1">; player.animTimer = </span><span class="s13">0</span><span class="s1">; } </span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">case</span><span class="s1"> </span><span class="s11">'jump'</span><span class="s1">: </span><span class="s10">if</span><span class="s1"> (player.dy &lt; -</span><span class="s13">5</span><span class="s1">) player.animIndex = </span><span class="s13">0</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (player.dy &lt; </span><span class="s13">0</span><span class="s1">) player.animIndex = </span><span class="s13">1</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (player.dy &lt; </span><span class="s13">5</span><span class="s1">) player.animIndex = </span><span class="s13">2</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> player.animIndex = </span><span class="s13">1</span><span class="s1">; </span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">case</span><span class="s1"> </span><span class="s11">'squat'</span><span class="s1">: player.animIndex = </span><span class="s13">0</span><span class="s1">; </span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">case</span><span class="s1"> </span><span class="s11">'dead'</span><span class="s1">: player.animIndex = </span><span class="s13">0</span><span class="s1">; </span><span class="s10">break</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> update() {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (isPaused) </span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (gameOver &amp;&amp; player.state !== </span><span class="s11">'dead'</span><span class="s1">) </span><span class="s10">return</span><span class="s1">; </span><span class="s10">if</span><span class="s1"> (player.state === </span><span class="s11">'dead'</span><span class="s1">) </span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (isTitle) { updateClouds(); </span><span class="s10">return</span><span class="s1">; }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>updateShake(); frameCount++; updateClouds();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (isInvincible) { invincibleTimer--; </span><span class="s10">if</span><span class="s1"> (invincibleTimer &lt;= </span><span class="s13">0</span><span class="s1">) isInvincible = </span><span class="s10">false</span><span class="s1">; }</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">     </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">let</span><span class="s1"> statusText = </span><span class="s11">""</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (superMode) { superModeTimer--; statusText += </span><span class="s11">"🌟SUPER MODE! "</span><span class="s1">; </span><span class="s10">if</span><span class="s1"> (superModeTimer &lt;= </span><span class="s13">0</span><span class="s1">) superMode = </span><span class="s10">false</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (slowMode) { slowModeTimer--; statusText += </span><span class="s11">"🐢SLOW... "</span><span class="s1">; </span><span class="s10">if</span><span class="s1"> (slowModeTimer &lt;= </span><span class="s13">0</span><span class="s1">) slowMode = </span><span class="s10">false</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>statusMsgEl.innerText = statusText;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (superMode) statusMsgEl.style.color = </span><span class="s11">"gold"</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (slowMode) statusMsgEl.style.color = </span><span class="s11">"violet"</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> statusMsgEl.innerText = </span><span class="s11">""</span><span class="s1">;</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">let</span><span class="s1"> currentSpeed = player.speed;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (slowMode) currentSpeed *= </span><span class="s13">0.5</span><span class="s1">;</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (player.state !== </span><span class="s11">'dead'</span><span class="s1">) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (player.state !== </span><span class="s11">'squat'</span><span class="s1">) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (keys.right) player.dx = currentSpeed; </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (keys.left) player.dx = -currentSpeed; </span><span class="s10">else</span><span class="s1"> player.dx *= </span><span class="s14">FRICTION</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>} </span><span class="s10">else</span><span class="s1"> { player.dx *= </span><span class="s14">FRICTION</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> nextX = player.x + player.dx; </span><span class="s10">let</span><span class="s1"> checkX = player.dx &gt; </span><span class="s13">0</span><span class="s1"> ? nextX + player.width : nextX;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> nextGroundY = getGroundYAtX(checkX);<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (nextGroundY !== </span><span class="s10">null</span><span class="s1">) { </span><span class="s10">if</span><span class="s1"> (player.y + player.height &gt; nextGroundY + </span><span class="s13">5</span><span class="s1">) player.dx = </span><span class="s13">0</span><span class="s1">; }</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// ★修正: カメラ位置での左端制限</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (nextX &lt; cameraX) { nextX = cameraX; player.dx = </span><span class="s13">0</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>player.x += player.dx; player.y += player.dy; player.dy += </span><span class="s14">GRAVITY</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">     </span></span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">// ★修正: カメラ追従計算 (プレイヤー中心に)</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">let</span><span class="s1"> targetCameraX = player.x - canvas.width / </span><span class="s13">2</span><span class="s1"> + player.width / </span><span class="s13">2</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (targetCameraX &lt; </span><span class="s13">0</span><span class="s1">) targetCameraX = </span><span class="s13">0</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (targetCameraX &gt; cameraX) cameraX = targetCameraX;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">     </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>updateTerrain();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">const</span><span class="s1"> groundY = getGroundYUnderPlayer();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (groundY !== </span><span class="s10">null</span><span class="s1">) {<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (player.y + player.height &gt;= groundY &amp;&amp; player.dy &gt;= </span><span class="s13">0</span><span class="s1">) { player.y = groundY - player.height; player.dy = </span><span class="s13">0</span><span class="s1">; player.jumping = </span><span class="s10">false</span><span class="s1">; player.combo = </span><span class="s13">0</span><span class="s1">; player.jumpCount = </span><span class="s13">0</span><span class="s1">; }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>} </span><span class="s10">else</span><span class="s1"> {<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (player.y &gt; canvas.height) { </span><span class="s10">if</span><span class="s1"> (isNaN(player.y)) player.y = </span><span class="s13">0</span><span class="s1">; </span><span class="s10">if</span><span class="s1"> (!gameOver) { hp = </span><span class="s13">0</span><span class="s1">; updateHearts(); playSound(</span><span class="s11">'hit'</span><span class="s1">); handleGameOver(); } }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">     </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>updatePlayerAnimation();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (gameOver) </span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>updateAndDrawParticles();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> i = </span><span class="s13">0</span><span class="s1">; i &lt; floatingTexts.length; i++) { </span><span class="s10">let</span><span class="s1"> ft = floatingTexts[i]; ft.y += ft.dy; ft.life--; </span><span class="s10">if</span><span class="s1"> (ft.life &lt;= </span><span class="s13">0</span><span class="s1">) { floatingTexts.splice(i, </span><span class="s13">1</span><span class="s1">); i--; } }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">let</span><span class="s1"> playerHitH = player.height; </span><span class="s10">let</span><span class="s1"> playerHitY = player.y;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (player.state === </span><span class="s11">'squat'</span><span class="s1">) { playerHitH = player.height / </span><span class="s13">2</span><span class="s1">; playerHitY = player.y + player.height / </span><span class="s13">2</span><span class="s1">; }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> i = </span><span class="s13">0</span><span class="s1">; i &lt; items.length; i++) {<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> item = items[i];<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (item.x + item.width &lt; cameraX - </span><span class="s13">100</span><span class="s1">) { items.splice(i, </span><span class="s13">1</span><span class="s1">); i--; </span><span class="s10">continue</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (item.isCollected) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (item.type === </span><span class="s11">'coin'</span><span class="s1">) { item.animTimer++; </span><span class="s10">if</span><span class="s1"> (item.animTimer &gt; </span><span class="s13">5</span><span class="s1">) { item.animIndex++; item.animTimer = </span><span class="s13">0</span><span class="s1">; } </span><span class="s10">if</span><span class="s1"> (item.animIndex &gt;= </span><span class="s13">3</span><span class="s1">) { items.splice(i, </span><span class="s13">1</span><span class="s1">); i--; } }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">else</span><span class="s1"> { item.animTimer++; </span><span class="s10">if</span><span class="s1"> (item.animTimer &gt; </span><span class="s13">30</span><span class="s1">) { items.splice(i, </span><span class="s13">1</span><span class="s1">); i--; } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>} </span><span class="s10">else</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>item.x += item.dx;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (item.x + item.width &lt; cameraX - </span><span class="s13">100</span><span class="s1">) { items.splice(i, </span><span class="s13">1</span><span class="s1">); i--; </span><span class="s10">continue</span><span class="s1">; }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (player.x &lt; item.x + item.width &amp;&amp; player.x + player.width &gt; item.x &amp;&amp; playerHitY &lt; item.y + item.height &amp;&amp; playerHitY + playerHitH &gt; item.y) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>item.isCollected = </span><span class="s10">true</span><span class="s1">; item.animIndex = </span><span class="s13">0</span><span class="s1">; item.animTimer = </span><span class="s13">0</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (item.type === </span><span class="s11">'coin'</span><span class="s1">) { score += </span><span class="s13">50</span><span class="s1">; playSound(</span><span class="s11">'coin'</span><span class="s1">); spawnParticles(item.x, item.y, </span><span class="s11">'gold'</span><span class="s1">, </span><span class="s13">5</span><span class="s1">); }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (item.type === </span><span class="s11">'heal'</span><span class="s1">) { hp = </span><span class="s13">3</span><span class="s1">; updateHearts(); playSound(</span><span class="s11">'heal'</span><span class="s1">); spawnParticles(item.x, item.y, </span><span class="s11">'pink'</span><span class="s1">, </span><span class="s13">8</span><span class="s1">); }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (item.type === </span><span class="s11">'star'</span><span class="s1">) { superMode = </span><span class="s10">true</span><span class="s1">; superModeTimer = </span><span class="s13">900</span><span class="s1">; isInvincible = </span><span class="s10">true</span><span class="s1">; invincibleTimer = </span><span class="s13">900</span><span class="s1">; slowMode = </span><span class="s10">false</span><span class="s1">; slowModeTimer = </span><span class="s13">0</span><span class="s1">; playSound(</span><span class="s11">'powerup'</span><span class="s1">); spawnParticles(item.x, item.y, </span><span class="s11">'yellow'</span><span class="s1">, </span><span class="s13">10</span><span class="s1">); }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (item.type === </span><span class="s11">'trap'</span><span class="s1">) { </span><span class="s10">if</span><span class="s1"> (!superMode) { slowMode = </span><span class="s10">true</span><span class="s1">; slowModeTimer = </span><span class="s13">600</span><span class="s1">; playSound(</span><span class="s11">'bad'</span><span class="s1">); spawnParticles(item.x, item.y, </span><span class="s11">'purple'</span><span class="s1">, </span><span class="s13">8</span><span class="s1">); } }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>scoreEl.innerText = score; updateLevel();<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">let</span><span class="s1"> stompedThisFrame = </span><span class="s10">false</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> i = </span><span class="s13">0</span><span class="s1">; i &lt; enemies.length; i++) {<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> e = enemies[i];<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (e.x + e.width &lt; cameraX - </span><span class="s13">100</span><span class="s1">) { enemies.splice(i, </span><span class="s13">1</span><span class="s1">); i--; </span><span class="s10">continue</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>e.x += e.dx;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>e.animTimer++; </span><span class="s10">if</span><span class="s1"> (e.animTimer &gt; </span><span class="s13">10</span><span class="s1">) { e.animIndex = (e.animIndex + </span><span class="s13">1</span><span class="s1">) % </span><span class="s13">2</span><span class="s1">; e.animTimer = </span><span class="s13">0</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (e.type === </span><span class="s11">'flying'</span><span class="s1">) { e.angle += </span><span class="s13">0.1</span><span class="s1">; e.y += </span><span class="s14">Math</span><span class="s1">.sin(e.angle) * </span><span class="s13">2</span><span class="s1">; }<span class="Apple-converted-space"> </span></span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (player.x &lt; e.x + e.width &amp;&amp; player.x + player.width &gt; e.x &amp;&amp; playerHitY &lt; e.y + e.height &amp;&amp; playerHitY + playerHitH &gt; e.y) {<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">const</span><span class="s1"> isStomp = (player.dy &gt; </span><span class="s13">0</span><span class="s1"> &amp;&amp; player.y + player.height &lt; e.y + e.height * </span><span class="s13">0.6</span><span class="s1">) || stompedThisFrame || superMode;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (isStomp) {<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>enemies.splice(i, </span><span class="s13">1</span><span class="s1">); i--;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (!superMode) { player.dy = -</span><span class="s13">10</span><span class="s1">; stompedThisFrame = </span><span class="s10">true</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>player.combo++; </span><span class="s10">let</span><span class="s1"> multiplier = </span><span class="s14">Math</span><span class="s1">.pow(</span><span class="s13">2</span><span class="s1">, player.combo - </span><span class="s13">1</span><span class="s1">); </span><span class="s10">let</span><span class="s1"> bonusPoints = </span><span class="s13">100</span><span class="s1"> * multiplier;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>score += bonusPoints; scoreEl.innerText = score; playSound(</span><span class="s11">'coin'</span><span class="s1">); updateLevel();<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (multiplier &gt; </span><span class="s13">1</span><span class="s1">) { floatingTexts.push({ x: player.x, y: player.y - </span><span class="s13">20</span><span class="s1">, text: </span><span class="s11">"BONUS x"</span><span class="s1"> + multiplier, life: </span><span class="s13">60</span><span class="s1">, dy: -</span><span class="s13">1.5</span><span class="s1"> }); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>spawnParticles(e.x, e.y, </span><span class="s11">'red'</span><span class="s1">, </span><span class="s13">8</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>} </span><span class="s10">else</span><span class="s1"> {<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (!isInvincible) {<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span>hp--; </span><span class="s10">if</span><span class="s1"> (hp &lt; </span><span class="s13">0</span><span class="s1">) hp = </span><span class="s13">0</span><span class="s1">; updateHearts(); playSound(</span><span class="s11">'hit'</span><span class="s1">); addShake(</span><span class="s13">15</span><span class="s1">, </span><span class="s13">20</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s10">if</span><span class="s1"> (hp &lt;= </span><span class="s13">0</span><span class="s1">) handleGameOver(); </span><span class="s10">else</span><span class="s1"> { isInvincible = </span><span class="s10">true</span><span class="s1">; invincibleTimer = </span><span class="s13">60</span><span class="s1">; enemies.splice(i, </span><span class="s13">1</span><span class="s1">); i--; }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>}<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>}<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> cp </span><span class="s10">of</span><span class="s1"> checkpoints) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (!cp.passed &amp;&amp; player.x &gt; cp.x) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>cp.passed = </span><span class="s10">true</span><span class="s1">; score += </span><span class="s13">1500</span><span class="s1">; scoreEl.innerText = score; playSound(</span><span class="s11">'gate'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>spawnParticles(player.x, player.y, </span><span class="s11">'cyan'</span><span class="s1">, </span><span class="s13">15</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>floatingTexts.push({ x: player.x, y: player.y - </span><span class="s13">40</span><span class="s1">, text: </span><span class="s11">"CHECKPOINT! +1500"</span><span class="s1">, life: </span><span class="s13">90</span><span class="s1">, dy: -</span><span class="s13">0.5</span><span class="s1"> });</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> drawParallaxLayer(imgWrapper, scrollFactor, y) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">if</span><span class="s1"> (!imgWrapper || !imgWrapper.ready) </span><span class="s10">return</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">const</span><span class="s1"> img = imgWrapper.img; </span><span class="s10">const</span><span class="s1"> w = img.width;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">let</span><span class="s1"> x = -(cameraX * scrollFactor) % w; </span><span class="s10">if</span><span class="s1"> (x &gt; </span><span class="s13">0</span><span class="s1">) x -= w;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s10">while</span><span class="s1"> (x &lt; canvas.width) { ctx.drawImage(img, x, y); x += w; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> drawObj(wrapper, x, y, w, h, fallbackColor) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (wrapper &amp;&amp; wrapper.ready &amp;&amp; wrapper.img) ctx.drawImage(wrapper.img, x, y, w, h);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">else</span><span class="s1"> { ctx.fillStyle = fallbackColor; ctx.fillRect(x, y, w, h); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> draw() {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>ctx.clearRect(</span><span class="s13">0</span><span class="s1">, </span><span class="s13">0</span><span class="s1">, canvas.width, canvas.height);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">let</span><span class="s1"> skyColor; </span><span class="s10">if</span><span class="s1"> (score &lt; </span><span class="s13">1000</span><span class="s1">) skyColor = </span><span class="s11">'#B0E0E6'</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (score &lt; </span><span class="s13">3000</span><span class="s1">) skyColor = </span><span class="s11">'#FFDAB9'</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (score &lt; </span><span class="s13">5000</span><span class="s1">) skyColor = </span><span class="s11">'#483D8B'</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> skyColor = </span><span class="s11">'#6A5ACD'</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>ctx.fillStyle = skyColor; ctx.fillRect(</span><span class="s13">0</span><span class="s1">, </span><span class="s13">0</span><span class="s1">, canvas.width, canvas.height);</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">     </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>ctx.save(); ctx.translate(screenShake.x, screenShake.y);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>drawParallaxLayer(mountainImgWrapper, </span><span class="s13">0.1</span><span class="s1">, canvas.height - </span><span class="s13">250</span><span class="s1">);<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1">(</span><span class="s10">let</span><span class="s1"> c </span><span class="s10">of</span><span class="s1"> clouds) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> wrapper = cloudImgWrappers[c.imgIndex]; </span><span class="s10">let</span><span class="s1"> parallaxX = c.x - cameraX * </span><span class="s13">0.2</span><span class="s1">;<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (wrapper &amp;&amp; wrapper.ready &amp;&amp; wrapper.img) ctx.drawImage(wrapper.img, parallaxX, c.y);<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">else</span><span class="s1"> { ctx.fillStyle = </span><span class="s11">'rgba(255, 255, 255, 0.5)'</span><span class="s1">; ctx.beginPath(); ctx.arc(parallaxX, c.y, </span><span class="s13">30</span><span class="s1">, </span><span class="s13">0</span><span class="s1">, </span><span class="s14">Math</span><span class="s1">.</span><span class="s14">PI</span><span class="s1">*</span><span class="s13">2</span><span class="s1">); ctx.fill(); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>drawParallaxLayer(buildingImgWrapper, </span><span class="s13">0.4</span><span class="s1">, canvas.height - </span><span class="s13">220</span><span class="s1">);<span class="Apple-converted-space"> </span></span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>ctx.translate(-cameraX, </span><span class="s13">0</span><span class="s1">);<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> seg </span><span class="s10">of</span><span class="s1"> terrainSegments) { ctx.fillStyle = </span><span class="s11">'#654321'</span><span class="s1">; ctx.fillRect(seg.x, seg.topY, seg.width, canvas.height - seg.topY); ctx.fillStyle = </span><span class="s11">'#228B22'</span><span class="s1">; ctx.fillRect(seg.x, seg.topY, seg.width, </span><span class="s13">10</span><span class="s1">); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>ctx.fillStyle = </span><span class="s11">'#999'</span><span class="s1">; ctx.strokeStyle = </span><span class="s11">'#555'</span><span class="s1">; </span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> p </span><span class="s10">of</span><span class="s1"> platforms) { ctx.fillRect(p.x, p.y, p.width, p.height); ctx.strokeRect(p.x, p.y, p.width, p.height); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>ctx.strokeStyle = </span><span class="s11">'yellow'</span><span class="s1">; ctx.lineWidth = </span><span class="s13">5</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> cp </span><span class="s10">of</span><span class="s1"> checkpoints) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>ctx.beginPath(); ctx.moveTo(cp.x, </span><span class="s14">BASE_GROUND_Y</span><span class="s1">); ctx.lineTo(cp.x, </span><span class="s14">BASE_GROUND_Y</span><span class="s1"> - </span><span class="s13">150</span><span class="s1">); ctx.arc(cp.x + </span><span class="s13">40</span><span class="s1">, </span><span class="s14">BASE_GROUND_Y</span><span class="s1"> - </span><span class="s13">150</span><span class="s1">, </span><span class="s13">40</span><span class="s1">, </span><span class="s14">Math</span><span class="s1">.</span><span class="s14">PI</span><span class="s1">, </span><span class="s13">0</span><span class="s1">); ctx.lineTo(cp.x + </span><span class="s13">80</span><span class="s1">, </span><span class="s14">BASE_GROUND_Y</span><span class="s1">); ctx.stroke();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (!cp.passed) { ctx.fillStyle = </span><span class="s11">'rgba(0, 255, 255, 0.3)'</span><span class="s1">; ctx.fill(); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> item </span><span class="s10">of</span><span class="s1"> items) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (item.isCollected) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (item.type === </span><span class="s11">'coin'</span><span class="s1">) { </span><span class="s10">let</span><span class="s1"> effectWrapper = itemEffectAnim[item.animIndex]; </span><span class="s10">if</span><span class="s1">(effectWrapper) drawObj(effectWrapper, item.x, item.y, item.width, item.height, </span><span class="s11">'yellow'</span><span class="s1">); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">else</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>ctx.save(); </span><span class="s10">if</span><span class="s1"> (</span><span class="s14">Math</span><span class="s1">.floor(</span><span class="s14">Date</span><span class="s1">.now() / </span><span class="s13">50</span><span class="s1">) % </span><span class="s13">2</span><span class="s1"> === </span><span class="s13">0</span><span class="s1">) ctx.globalAlpha = </span><span class="s13">0.2</span><span class="s1">; </span><span class="s10">else</span><span class="s1"> ctx.globalAlpha = </span><span class="s13">0.8</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s10">if</span><span class="s1"> (item.type === </span><span class="s11">'heal'</span><span class="s1">) drawObj(capsuleImgWrapper, item.x, item.y, item.width, item.height, </span><span class="s11">'pink'</span><span class="s1">); </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (item.type === </span><span class="s11">'star'</span><span class="s1">) drawObj(mutekiImgWrapper, item.x, item.y, item.width, item.height, </span><span class="s11">'yellow'</span><span class="s1">); </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (item.type === </span><span class="s11">'trap'</span><span class="s1">) drawObj(jyamaImgWrapper, item.x, item.y, item.width, item.height, </span><span class="s11">'purple'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">                </span>ctx.restore();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>} </span><span class="s10">else</span><span class="s1"> {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s10">if</span><span class="s1"> (item.type === </span><span class="s11">'coin'</span><span class="s1">) drawObj(itemImgWrapper, item.x, item.y, item.width, item.height, </span><span class="s11">'gold'</span><span class="s1">); </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (item.type === </span><span class="s11">'heal'</span><span class="s1">) drawObj(capsuleImgWrapper, item.x, item.y, item.width, item.height, </span><span class="s11">'pink'</span><span class="s1">); </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (item.type === </span><span class="s11">'star'</span><span class="s1">) drawObj(mutekiImgWrapper, item.x, item.y, item.width, item.height, </span><span class="s11">'yellow'</span><span class="s1">); </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (item.type === </span><span class="s11">'trap'</span><span class="s1">) drawObj(jyamaImgWrapper, item.x, item.y, item.width, item.height, </span><span class="s11">'purple'</span><span class="s1">);</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> e </span><span class="s10">of</span><span class="s1"> enemies) {<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">let</span><span class="s1"> animWrapper = </span><span class="s10">null</span><span class="s1">; </span><span class="s10">if</span><span class="s1"> (e.type === </span><span class="s11">'hard'</span><span class="s1">) { animWrapper = enemy2Anim[e.animIndex] || enemy2Anim[</span><span class="s13">0</span><span class="s1">]; drawObj(animWrapper, e.x, e.y, e.width, e.height, </span><span class="s11">'purple'</span><span class="s1">); } </span><span class="s10">else</span><span class="s1"> { animWrapper = enemyAnim[e.animIndex] || enemyAnim[</span><span class="s13">0</span><span class="s1">]; drawObj(animWrapper, e.x, e.y, e.width, e.height, </span><span class="s11">'red'</span><span class="s1">); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>ctx.save();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (superMode) { </span><span class="s10">if</span><span class="s1"> (</span><span class="s14">Math</span><span class="s1">.floor(</span><span class="s14">Date</span><span class="s1">.now() / </span><span class="s13">50</span><span class="s1">) % </span><span class="s13">2</span><span class="s1"> === </span><span class="s13">0</span><span class="s1">) { ctx.globalAlpha = </span><span class="s13">0.8</span><span class="s1">; ctx.filter = </span><span class="s11">'brightness(1.5) drop-shadow(0 0 5px gold)'</span><span class="s1">; } }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (slowMode) { ctx.filter = </span><span class="s11">'hue-rotate(270deg)'</span><span class="s1">; }<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (isInvincible) { </span><span class="s10">if</span><span class="s1"> (</span><span class="s14">Math</span><span class="s1">.floor(</span><span class="s14">Date</span><span class="s1">.now() / </span><span class="s13">100</span><span class="s1">) % </span><span class="s13">2</span><span class="s1"> === </span><span class="s13">0</span><span class="s1">) ctx.globalAlpha = </span><span class="s13">0.5</span><span class="s1">; }</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">     </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">let</span><span class="s1"> currentWrapper = </span><span class="s10">null</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (player.state === </span><span class="s11">'dead'</span><span class="s1">) currentWrapper = playerAnim.dead; </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (player.state === </span><span class="s11">'squat'</span><span class="s1">) currentWrapper = playerAnim.squat; </span><span class="s10">else</span><span class="s1"> </span><span class="s10">if</span><span class="s1"> (playerAnim[player.state] &amp;&amp; playerAnim[player.state][player.animIndex]) currentWrapper = playerAnim[player.state][player.animIndex];</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">if</span><span class="s1"> (!isNaN(player.x) &amp;&amp; !isNaN(player.y)) {</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s10">if</span><span class="s1"> (!facingRight) { ctx.translate(player.x + player.width, player.y); ctx.scale(-</span><span class="s13">1</span><span class="s1">, </span><span class="s13">1</span><span class="s1">); drawObj(currentWrapper, </span><span class="s13">0</span><span class="s1">, </span><span class="s13">0</span><span class="s1">, player.width, player.height, </span><span class="s11">'blue'</span><span class="s1">); } </span><span class="s10">else</span><span class="s1"> { drawObj(currentWrapper, player.x, player.y, player.width, player.height, </span><span class="s11">'blue'</span><span class="s1">); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>ctx.restore();</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1">(</span><span class="s10">let</span><span class="s1"> p </span><span class="s10">of</span><span class="s1"> particles) { ctx.fillStyle = p.color; ctx.globalAlpha = </span><span class="s14">Math</span><span class="s1">.min(p.life / </span><span class="s13">20</span><span class="s1">, </span><span class="s13">1.0</span><span class="s1">); ctx.fillRect(p.x, p.y, p.size, p.size); ctx.globalAlpha = </span><span class="s13">1.0</span><span class="s1">; }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>ctx.fillStyle = </span><span class="s11">"yellow"</span><span class="s1">; ctx.font = </span><span class="s11">"bold 20px Courier New"</span><span class="s1">; ctx.strokeStyle = </span><span class="s11">"black"</span><span class="s1">; ctx.lineWidth = </span><span class="s13">3</span><span class="s1">;</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s10">for</span><span class="s1"> (</span><span class="s10">let</span><span class="s1"> ft </span><span class="s10">of</span><span class="s1"> floatingTexts) { ctx.strokeText(ft.text, ft.x, ft.y); ctx.fillText(ft.text, ft.x, ft.y); }</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>ctx.restore();</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s10">function</span><span class="s1"> loop() { </span><span class="s10">if</span><span class="s1"> (!isPaused) update(); draw(); requestAnimationFrame(loop); }</span></p>
<p class="p7"><span class="s8"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>resetGame(); loop();<span class="Apple-converted-space"> </span></span></p>
<p class="p2"><span class="s3">&lt;/</span><span class="s1">script</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;/</span><span class="s1">body</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;/</span><span class="s1">html</span><span class="s3">&gt;</span></p>
</body>
</html>
